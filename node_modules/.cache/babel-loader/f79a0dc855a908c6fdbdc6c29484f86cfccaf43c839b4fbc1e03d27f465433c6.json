{"ast":null,"code":"import { getServiceClient } from \"../lib/supabaseClient\";\nimport { TABLES } from \"../utils/constants/tables\";\nimport * as documentService from './documentService';\nimport { ErrorType, createAppError, logError, handleApiError, isRlsViolation, createRlsViolationError, createNoEffectError } from '../utils/errorHandling';\nimport { processNumericField } from '../utils/numberFormatting';\nimport { uploadClientDocuments as uploadDocs } from '../utils/documentUpload';\n\n// Re-exportamos las interfaces para mantener compatibilidad\n\nconst USERS_TABLE = 'users';\nconst mapUserToClient = userData => {\n  if (!userData) {\n    console.error('Error: userData is undefined in mapUserToClient');\n    throw new Error('No se pudo procesar la información del cliente, los datos son inválidos');\n  }\n\n  // Generar el nombre completo a partir de los componentes del nombre\n  const fullName = userData.name || [userData.first_name, userData.paternal_surname, userData.maternal_surname].filter(Boolean).join(' ');\n\n  // Crear el objeto cliente con todos los campos de la base de datos\n  const client = {\n    id: userData.id,\n    created_at: userData.created_at,\n    last_login: userData.last_login,\n    name: fullName,\n    // Campo calculado/virtual - no existe en la base de datos\n    first_name: userData.first_name,\n    paternal_surname: userData.paternal_surname,\n    maternal_surname: userData.maternal_surname,\n    email: userData.email,\n    phone: userData.phone,\n    birth_date: userData.birth_date,\n    company_id: userData.company_id,\n    rfc: userData.rfc,\n    curp: userData.curp,\n    advisor_id: userData.advisor_id,\n    address: userData.address,\n    city: userData.city,\n    state: userData.state,\n    postal_code: userData.postal_code,\n    gender: userData.gender,\n    marital_status: userData.marital_status,\n    employment_type: userData.employment_type,\n    employment_years: userData.employment_years,\n    monthly_income: userData.monthly_income,\n    additional_income: userData.additional_income,\n    monthly_expenses: userData.monthly_expenses,\n    other_loan_balances: userData.other_loan_balances,\n    bank_name: userData.bank_name,\n    bank_clabe: userData.bank_clabe,\n    bank_account_number: userData.bank_account_number,\n    bank_account_type: userData.bank_account_type,\n    bank_account_origin: userData.bank_account_origin,\n    street_number_ext: userData.street_number_ext,\n    street_number_int: userData.street_number_int,\n    neighborhood: userData.neighborhood,\n    home_phone: userData.home_phone,\n    birth_state: userData.birth_state,\n    nationality: userData.nationality,\n    job_position: userData.job_position,\n    employer_name: userData.employer_name,\n    employer_phone: userData.employer_phone,\n    employer_address: userData.employer_address,\n    employer_activity: userData.employer_activity,\n    mortgage_payment: userData.mortgage_payment,\n    rent_payment: userData.rent_payment,\n    dependent_persons: userData.dependent_persons,\n    income_frequency: userData.income_frequency,\n    payment_method: userData.payment_method,\n    credit_purpose: userData.credit_purpose,\n    spouse_paternal_surname: userData.spouse_paternal_surname,\n    spouse_maternal_surname: userData.spouse_maternal_surname,\n    reference1_name: userData.reference1_name,\n    reference1_relationship: userData.reference1_relationship,\n    reference1_address: userData.reference1_address,\n    reference1_phone: userData.reference1_phone,\n    reference2_name: userData.reference2_name,\n    reference2_relationship: userData.reference2_relationship,\n    reference2_address: userData.reference2_address,\n    reference2_phone: userData.reference2_phone\n  };\n  return client;\n};\nexport const getClients = async filters => {\n  try {\n    // Usamos el cliente de servicio para evitar problemas de autenticación\n    const serviceClient = getServiceClient();\n    let query = serviceClient.from(USERS_TABLE).select('id, email, first_name, paternal_surname, maternal_surname, phone, company_id, created_at, birth_date, rfc, curp, advisor_id, address, city, state, postal_code, gender, marital_status, employment_type, employment_years, monthly_income, additional_income, monthly_expenses, other_loan_balances, bank_name, bank_clabe, bank_account_number, bank_account_type, bank_account_origin, street_number_ext, street_number_int, neighborhood, home_phone, birth_state, nationality, job_position, employer_name, employer_phone, employer_address, employer_activity, mortgage_payment, rent_payment, dependent_persons, income_frequency, payment_method, credit_purpose, spouse_paternal_surname, spouse_maternal_surname, reference1_name, reference1_relationship, reference1_address, reference1_phone, reference2_name, reference2_relationship, reference2_address, reference2_phone, last_login', {\n      count: 'exact'\n    });\n    if (filters) {\n      if (filters.advisor_id) {\n        query = query.eq('advisor_id', filters.advisor_id);\n      }\n      if (filters.company_id) {\n        query = query.eq('company_id', filters.company_id);\n      }\n      if (filters.dateFrom) {\n        query = query.gte('created_at', filters.dateFrom);\n      }\n      if (filters.dateTo) {\n        query = query.lte('created_at', filters.dateTo);\n      }\n      if (filters.searchQuery) {\n        query = query.or(`first_name.ilike.%${filters.searchQuery}%,paternal_surname.ilike.%${filters.searchQuery}%,maternal_surname.ilike.%${filters.searchQuery}%,email.ilike.%${filters.searchQuery}%,phone.ilike.%${filters.searchQuery}%,rfc.ilike.%${filters.searchQuery}%,curp.ilike.%${filters.searchQuery}%`);\n      }\n      if (filters.page !== undefined && filters.pageSize) {\n        const from = filters.page * filters.pageSize;\n        const to = from + filters.pageSize - 1;\n        query = query.range(from, to);\n      }\n    }\n    query = query.order('created_at', {\n      ascending: false\n    });\n    const {\n      data,\n      error,\n      count\n    } = await query;\n    if (error) {\n      logError(error, 'getClients', {\n        filters\n      });\n      throw handleApiError(error);\n    }\n    const clients = data ? data.map(mapUserToClient) : [];\n    return {\n      clients,\n      totalCount: count || 0\n    };\n  } catch (error) {\n    logError(error, 'getClients', {\n      filters\n    });\n    throw handleApiError(error);\n  }\n};\nexport const getClientById = async id => {\n  try {\n    // Usamos el cliente de servicio para evitar problemas de autenticación\n    const serviceClient = getServiceClient();\n    const {\n      data,\n      error\n    } = await serviceClient.from(USERS_TABLE).select('id, email, first_name, paternal_surname, maternal_surname, phone, company_id, created_at, birth_date, rfc, curp, advisor_id, address, city, state, postal_code, gender, marital_status, employment_type, employment_years, monthly_income, additional_income, monthly_expenses, other_loan_balances, bank_name, bank_clabe, bank_account_number, bank_account_type, bank_account_origin, street_number_ext, street_number_int, neighborhood, home_phone, birth_state, nationality, job_position, employer_name, employer_phone, employer_address, employer_activity, mortgage_payment, rent_payment, dependent_persons, income_frequency, payment_method, credit_purpose, spouse_paternal_surname, spouse_maternal_surname, reference1_name, reference1_relationship, reference1_address, reference1_phone, reference2_name, reference2_relationship, reference2_address, reference2_phone, last_login').eq('id', id).single();\n    if (error) {\n      logError(error, 'getClientById', {\n        clientId: id\n      });\n      throw handleApiError(error);\n    }\n    if (!data) {\n      const notFoundError = createAppError(ErrorType.NOT_FOUND, `No se encontró cliente con ID: ${id}`);\n      logError(notFoundError, 'getClientById', {\n        clientId: id\n      });\n      throw notFoundError;\n    }\n    return mapUserToClient(data);\n  } catch (error) {\n    logError(error, 'getClientById', {\n      clientId: id\n    });\n    throw handleApiError(error);\n  }\n};\nfunction escapeSQLString(str) {\n  if (!str) return '';\n  return str.replace(/'/g, \"''\");\n}\nexport const getClientApplications = async clientId => {\n  try {\n    const client = await getClientById(clientId).catch(err => {\n      console.error(`Error obteniendo cliente con ID ${clientId}:`, err);\n      throw handleApiError(err);\n    });\n    if (!client) {\n      const notFoundError = createAppError(ErrorType.NOT_FOUND, `El cliente no existe`);\n      logError(notFoundError, 'getClientApplications', {\n        clientId\n      });\n      return [];\n    }\n\n    // Construir la consulta con el nombre del cliente\n    const query = `\n      SELECT * FROM ${TABLES.APPLICATIONS}\n      WHERE client_name = '${escapeSQLString(client.name || '')}'\n      ORDER BY created_at DESC\n    `;\n    console.log(`Ejecutando consulta para obtener aplicaciones del cliente ${clientId}:`, query);\n\n    // Utilizamos el servicio de consulta SQL directo que evita problemas de RLS\n    const executeQuery = async query => {\n      try {\n        const response = await fetch('http://localhost:3100/query', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({\n            query: query\n          })\n        });\n        if (!response.ok) {\n          throw new Error(`Error en la respuesta HTTP: ${response.status} ${response.statusText}`);\n        }\n        const result = await response.json();\n        if (result.error) {\n          console.error('Error en la consulta SQL:', result.error);\n          throw new Error(result.error);\n        }\n        return result.data || [];\n      } catch (error) {\n        console.error('Error ejecutando la consulta:', error);\n        throw error;\n      }\n    };\n    const data = await executeQuery(query);\n    console.log(`Aplicaciones encontradas para el cliente ${clientId}:`, data.length);\n    return data;\n  } catch (error) {\n    logError(error, 'getClientApplications', {\n      clientId\n    });\n    console.error(`Error completo al obtener aplicaciones para cliente ${clientId}:`, error);\n    // Devolvemos un array vacío en caso de error para no interrumpir el flujo\n    return [];\n  }\n};\nexport const uploadClientDocuments = async (clientId, documents, userId) => {\n  if (!clientId) {\n    console.error('Client ID is required for uploading documents');\n    throw new Error('El ID del cliente es requerido para subir documentos');\n  }\n\n  // Verificar que se proporcionaron documentos válidos\n  if (!documents || !Array.isArray(documents) || documents.length === 0) {\n    console.error('No valid documents provided for upload');\n    throw new Error('No se proporcionaron documentos válidos para subir');\n  }\n  if (!userId) {\n    console.error('User ID is required for uploading documents');\n    throw new Error('Se requiere el ID del usuario para subir documentos');\n  }\n  try {\n    // Obtener cliente con permisos de servicio para operaciones que requieren más privilegios\n    const serviceClient = getServiceClient();\n\n    // Asegurarse de que el bucket de almacenamiento exista\n    await documentService.ensureStorageBucketExists(serviceClient);\n\n    // Intentar subir cada documento\n    const uploadPromises = documents.map(async document => {\n      try {\n        // Verificar que el documento tenga datos válidos\n        if (!document.file || !document.name) {\n          console.error('Invalid document data', document);\n          throw new Error('Datos de documento inválidos: se requiere archivo y nombre');\n        }\n\n        // Create a document upload request compatible with the document service\n        const uploadParams = {\n          file: document.file,\n          category: document.category,\n          documentName: document.name,\n          description: document.description,\n          userId: userId,\n          client_id: clientId,\n          authClient: serviceClient\n        };\n\n        // Subir el documento\n        return await documentService.uploadDocument(uploadParams);\n      } catch (docError) {\n        // Manejo de errores específicos de permisos RLS\n        if (docError.message && (docError.message.includes('permission denied') || docError.message.includes('not authorized') || docError.message.includes('row level security'))) {\n          console.error('Permission error when uploading document:', docError);\n          throw new Error('No tienes permiso para subir documentos para este cliente. Verifica tus permisos.');\n        }\n\n        // Registrar el error pero permitir que otros uploads continúen\n        console.error(`Error uploading document for client ${clientId}:`, docError);\n        throw docError;\n      }\n    });\n    const results = await Promise.all(uploadPromises);\n    return results;\n  } catch (error) {\n    logError(error, 'uploadClientDocuments', {\n      clientId\n    });\n    throw handleApiError(error);\n  }\n};\nexport const createClient = async (client, documents, userId) => {\n  try {\n    // Create a copy to avoid modifying the original object\n    const userData = {\n      email: client.email,\n      first_name: client.first_name || '',\n      paternal_surname: client.paternal_surname || '',\n      maternal_surname: client.maternal_surname || '',\n      phone: client.phone,\n      birth_date: client.birth_date,\n      company_id: client.company_id,\n      rfc: client.rfc,\n      curp: client.curp,\n      advisor_id: client.advisor_id,\n      address: client.address,\n      city: client.city,\n      state: client.state,\n      postal_code: client.postal_code,\n      gender: client.gender,\n      marital_status: client.marital_status,\n      employment_type: client.employment_type,\n      employment_years: client.employment_years,\n      monthly_income: client.monthly_income,\n      additional_income: client.additional_income,\n      monthly_expenses: client.monthly_expenses,\n      other_loan_balances: client.other_loan_balances,\n      bank_name: client.bank_name,\n      bank_clabe: client.bank_clabe,\n      bank_account_number: client.bank_account_number,\n      bank_account_type: client.bank_account_type,\n      bank_account_origin: client.bank_account_origin,\n      street_number_ext: client.street_number_ext,\n      street_number_int: client.street_number_int,\n      neighborhood: client.neighborhood,\n      home_phone: client.home_phone,\n      birth_state: client.birth_state,\n      nationality: client.nationality,\n      job_position: client.job_position,\n      employer_name: client.employer_name,\n      employer_phone: client.employer_phone,\n      employer_address: client.employer_address,\n      employer_activity: client.employer_activity,\n      mortgage_payment: client.mortgage_payment,\n      rent_payment: client.rent_payment,\n      dependent_persons: client.dependent_persons,\n      income_frequency: client.income_frequency,\n      payment_method: client.payment_method,\n      credit_purpose: client.credit_purpose,\n      spouse_paternal_surname: client.spouse_paternal_surname,\n      spouse_maternal_surname: client.spouse_maternal_surname,\n      reference1_name: client.reference1_name,\n      reference1_relationship: client.reference1_relationship,\n      reference1_address: client.reference1_address,\n      reference1_phone: client.reference1_phone,\n      reference2_name: client.reference2_name,\n      reference2_relationship: client.reference2_relationship,\n      reference2_address: client.reference2_address,\n      reference2_phone: client.reference2_phone\n    };\n\n    // Asegurarse de que no se incluyan campos calculados\n    // Estos campos son calculados en la aplicación pero no existen en la base de datos\n    delete userData.name;\n    delete userData.warningMessage;\n\n    // Process numeric fields\n    if (userData.employment_years !== undefined) {\n      const processed = processNumericField(userData.employment_years);\n      userData.employment_years = processed === null ? undefined : processed;\n    }\n    if (userData.monthly_income !== undefined) {\n      const processed = processNumericField(userData.monthly_income);\n      userData.monthly_income = processed === null ? undefined : processed;\n    }\n    if (userData.additional_income !== undefined) {\n      const processed = processNumericField(userData.additional_income);\n      userData.additional_income = processed === null ? undefined : processed;\n    }\n    if (userData.monthly_expenses !== undefined) {\n      const processed = processNumericField(userData.monthly_expenses);\n      userData.monthly_expenses = processed === null ? undefined : processed;\n    }\n    if (userData.other_loan_balances !== undefined) {\n      const processed = processNumericField(userData.other_loan_balances);\n      userData.other_loan_balances = processed === null ? undefined : processed;\n    }\n\n    // Ensure company_id is present as it's required by the database schema\n    if (!userData.company_id) {\n      console.warn('No company_id provided when creating client - using default company');\n      userData.company_id = \"70b2aa97-a5b6-4b5e-91db-be8acbd3701a\"; // Default company (Herramental)\n    }\n\n    // Log sanitized data for debugging\n    console.log(`Creating client with sanitized data:`, JSON.stringify(userData));\n\n    // Get the service client for this operation to evitar problemas de autenticación\n    const serviceClient = getServiceClient();\n    const {\n      data,\n      error,\n      count\n    } = await serviceClient.from(USERS_TABLE).insert([userData]).select();\n    if (error) {\n      // Verificar si es una violación de RLS\n      if (isRlsViolation(error)) {\n        throw createRlsViolationError('crear', 'cliente', 'nuevo', error);\n      }\n      logError(error, 'createClient');\n      throw handleApiError(error);\n    }\n\n    // Verify that rows were affected\n    if (!data || data.length === 0 || count === 0) {\n      const noDataError = createAppError(ErrorType.SERVER, 'No se pudo crear el cliente. No se recibieron datos del servidor.');\n      logError(noDataError, 'createClient');\n      throw noDataError;\n    }\n    const newClient = mapUserToClient(data[0]);\n    let documentResult = null;\n    if (documents && documents.length > 0 && userId && newClient.id) {\n      try {\n        console.log(`Uploading ${documents.length} documents for new client ${newClient.id}`);\n\n        // Usar la versión mejorada de uploadClientDocuments de utils\n        documentResult = await uploadDocs(newClient.id, documents);\n\n        // Check if any documents uploaded successfully\n        if (documentResult && documentResult.length > 0) {\n          console.log(`${documentResult.length} documents uploaded successfully during client creation`);\n        } else {\n          console.warn(`No documents were successfully uploaded during client creation`);\n          newClient.warningMessage = 'Se creó el cliente, pero no se pudieron subir los documentos. Puede intentar agregarlos nuevamente más tarde.';\n        }\n      } catch (docError) {\n        console.error('Error uploading documents during client creation:', docError);\n\n        // Información más detallada del error\n        const errorMessage = docError instanceof Error ? docError.message : 'Error desconocido';\n        console.error(`Error detail: ${errorMessage}`);\n\n        // Continue with client creation but add warning\n        newClient.warningMessage = `Se creó el cliente, pero hubo un problema al subir los documentos: ${errorMessage}. Puede intentar agregarlos nuevamente más tarde.`;\n      }\n    }\n    return newClient;\n  } catch (error) {\n    logError(error, 'createClient', {\n      clientData: client\n    });\n    throw handleApiError(error);\n  }\n};\nexport const updateClient = async (id, updates, documents, userId) => {\n  try {\n    console.log(`Starting client update for ID ${id}`, updates);\n\n    // Create a copy to avoid modifying the original object\n    const userUpdates = {\n      ...updates\n    };\n\n    // Eliminar campos calculados o virtuales que no existen en la base de datos\n    // El campo 'name' es calculado en mapUserToClient pero no existe en la tabla\n    delete userUpdates.name;\n    delete userUpdates.warningMessage;\n\n    // Process specific numeric fields\n    if ('employment_years' in updates) {\n      const processed = processNumericField(updates.employment_years);\n      userUpdates.employment_years = processed === null ? undefined : processed;\n    }\n    if ('monthly_income' in updates) {\n      const processed = processNumericField(updates.monthly_income);\n      userUpdates.monthly_income = processed === null ? undefined : processed;\n    }\n    if ('additional_income' in updates) {\n      const processed = processNumericField(updates.additional_income);\n      userUpdates.additional_income = processed === null ? undefined : processed;\n    }\n    if ('monthly_expenses' in updates) {\n      const processed = processNumericField(updates.monthly_expenses);\n      userUpdates.monthly_expenses = processed === null ? undefined : processed;\n    }\n    if ('other_loan_balances' in updates) {\n      const processed = processNumericField(updates.other_loan_balances);\n      userUpdates.other_loan_balances = processed === null ? undefined : processed;\n    }\n    if ('mortgage_payment' in updates) {\n      const processed = processNumericField(updates.mortgage_payment);\n      userUpdates.mortgage_payment = processed === null ? undefined : processed;\n    }\n    if ('rent_payment' in updates) {\n      const processed = processNumericField(updates.rent_payment);\n      userUpdates.rent_payment = processed === null ? undefined : processed;\n    }\n    if ('dependent_persons' in updates) {\n      const processed = processNumericField(updates.dependent_persons);\n      userUpdates.dependent_persons = processed === null ? undefined : processed;\n    }\n\n    // Remove undefined fields\n    Object.keys(userUpdates).forEach(key => {\n      const typedKey = key;\n      if (userUpdates[typedKey] === undefined) {\n        delete userUpdates[typedKey];\n      }\n    });\n    console.log(`Updating client ${id} with sanitized data:`, JSON.stringify(userUpdates));\n\n    // Get the service client for this operation to evitar problemas de permisos\n    const serviceClient = getServiceClient();\n\n    // First, verify the client exists\n    const {\n      data: existingClient,\n      error: existingError\n    } = await serviceClient.from(USERS_TABLE).select('id').eq('id', id).single();\n    if (existingError || !existingClient) {\n      const notFoundError = createAppError(ErrorType.NOT_FOUND, `No se encontró el cliente con ID ${id}. Verifique que el cliente exista.`);\n      logError(notFoundError, 'updateClient', {\n        clientId: id\n      });\n      throw notFoundError;\n    }\n\n    // Perform the update with the service client\n    const {\n      data,\n      error,\n      count\n    } = await serviceClient.from(USERS_TABLE).update(userUpdates).eq('id', id).select();\n    if (error) {\n      // Verificar si es una violación de RLS\n      if (isRlsViolation(error)) {\n        throw createRlsViolationError('actualizar', 'cliente', id, error);\n      }\n      logError(error, 'updateClient', {\n        clientId: id\n      });\n      throw handleApiError(error);\n    }\n\n    // Verify that the update affected rows\n    if (!data || data.length === 0 || count === 0) {\n      console.warn(`Update operation didn't affect any rows for client ${id}`);\n      throw createNoEffectError('update', 'cliente', id);\n    }\n    let updatedClient;\n    if (!data || data.length === 0) {\n      console.log(`No data returned when updating client with ID ${id}, fetching client data separately`);\n\n      // Fallback: fetch the client data separately\n      const {\n        data: fetchedData,\n        error: fetchError\n      } = await serviceClient.from(USERS_TABLE).select('*').eq('id', id).single();\n      if (fetchError) {\n        console.error('Error fetching updated client:', fetchError);\n        throw fetchError;\n      }\n      updatedClient = mapUserToClient(fetchedData);\n    } else {\n      updatedClient = mapUserToClient(data[0]);\n    }\n    let documentResult = null;\n\n    // Upload documents if provided\n    if (documents && documents.length > 0 && userId) {\n      try {\n        console.log(`Uploading ${documents.length} documents for client ${id}`);\n\n        // Usar la versión mejorada de uploadClientDocuments de utils\n        documentResult = await uploadDocs(id, documents);\n\n        // Check if any documents failed to upload\n        if (documentResult && documentResult.length > 0) {\n          console.log(`${documentResult.length} documents uploaded successfully during client update`);\n        } else {\n          console.warn(`No documents were successfully uploaded during client update`);\n          updatedClient.warningMessage = 'Se actualizó el cliente, pero no se pudieron subir los documentos. Puede intentar agregarlos nuevamente más tarde.';\n        }\n      } catch (docError) {\n        console.error(`Error uploading documents for client ${id}:`, docError);\n\n        // Información más detallada del error\n        const errorMessage = docError instanceof Error ? docError.message : 'Error desconocido';\n        console.error(`Error detail: ${errorMessage}`);\n\n        // Continue with client update but add warning\n        updatedClient.warningMessage = `Se actualizó el cliente, pero hubo un problema al subir los documentos: ${errorMessage}. Puede intentar agregarlos nuevamente más tarde.`;\n      }\n    }\n    console.log(`Client update complete for ID ${id}`);\n    return updatedClient;\n  } catch (error) {\n    logError(error, 'updateClient', {\n      clientId: id,\n      updates\n    });\n    throw handleApiError(error);\n  }\n};\nexport const deleteClient = async id => {\n  try {\n    // Get the service client for this operation\n    const serviceClient = getServiceClient();\n    const {\n      error,\n      count\n    } = await serviceClient.from(USERS_TABLE).delete().eq('id', id);\n    if (error) {\n      // Verificar si es una violación de RLS\n      if (isRlsViolation(error)) {\n        throw createRlsViolationError('eliminar', 'cliente', id, error);\n      }\n      logError(error, 'deleteClient', {\n        clientId: id\n      });\n      throw handleApiError(error);\n    }\n\n    // Verify that rows were affected\n    if (count === 0) {\n      console.warn(`Delete operation didn't affect any rows for client ${id}`);\n      throw createNoEffectError('delete', 'cliente', id);\n    }\n    return true;\n  } catch (error) {\n    logError(error, 'deleteClient', {\n      clientId: id\n    });\n    throw handleApiError(error);\n  }\n};\nexport const checkClientExists = async (email, rfc) => {\n  try {\n    const serviceClient = getServiceClient();\n    let query = serviceClient.from(USERS_TABLE).select('id, email, rfc').eq('email', email);\n    if (rfc) {\n      query = query.or(`rfc.eq.${rfc}`);\n    }\n    const {\n      data,\n      error\n    } = await query;\n    if (error) {\n      logError(error, 'checkClientExists', {\n        email,\n        rfc\n      });\n      throw handleApiError(error);\n    }\n    return (data === null || data === void 0 ? void 0 : data.length) > 0;\n  } catch (error) {\n    logError(error, 'checkClientExists', {\n      email,\n      rfc\n    });\n    throw handleApiError(error);\n  }\n};\nexport const getClientCount = async filters => {\n  try {\n    const serviceClient = getServiceClient();\n    let query = serviceClient.from(USERS_TABLE).select('*', {\n      count: 'exact',\n      head: true\n    });\n    if (filters) {\n      if (filters.advisor_id) {\n        query = query.eq('advisor_id', filters.advisor_id);\n      }\n      if (filters.company_id) {\n        query = query.eq('company_id', filters.company_id);\n      }\n      if (filters.dateFrom) {\n        query = query.gte('created_at', filters.dateFrom);\n      }\n      if (filters.dateTo) {\n        query = query.lte('created_at', filters.dateTo);\n      }\n    }\n    const {\n      count,\n      error\n    } = await query;\n    if (error) {\n      logError(error, 'getClientCount', {\n        filters\n      });\n      throw handleApiError(error);\n    }\n    return count || 0;\n  } catch (error) {\n    logError(error, 'getClientCount', {\n      filters\n    });\n    throw handleApiError(error);\n  }\n};","map":{"version":3,"names":["getServiceClient","TABLES","documentService","ErrorType","createAppError","logError","handleApiError","isRlsViolation","createRlsViolationError","createNoEffectError","processNumericField","uploadClientDocuments","uploadDocs","USERS_TABLE","mapUserToClient","userData","console","error","Error","fullName","name","first_name","paternal_surname","maternal_surname","filter","Boolean","join","client","id","created_at","last_login","email","phone","birth_date","company_id","rfc","curp","advisor_id","address","city","state","postal_code","gender","marital_status","employment_type","employment_years","monthly_income","additional_income","monthly_expenses","other_loan_balances","bank_name","bank_clabe","bank_account_number","bank_account_type","bank_account_origin","street_number_ext","street_number_int","neighborhood","home_phone","birth_state","nationality","job_position","employer_name","employer_phone","employer_address","employer_activity","mortgage_payment","rent_payment","dependent_persons","income_frequency","payment_method","credit_purpose","spouse_paternal_surname","spouse_maternal_surname","reference1_name","reference1_relationship","reference1_address","reference1_phone","reference2_name","reference2_relationship","reference2_address","reference2_phone","getClients","filters","serviceClient","query","from","select","count","eq","dateFrom","gte","dateTo","lte","searchQuery","or","page","undefined","pageSize","to","range","order","ascending","data","clients","map","totalCount","getClientById","single","clientId","notFoundError","NOT_FOUND","escapeSQLString","str","replace","getClientApplications","catch","err","APPLICATIONS","log","executeQuery","response","fetch","method","headers","body","JSON","stringify","ok","status","statusText","result","json","length","documents","userId","Array","isArray","ensureStorageBucketExists","uploadPromises","document","file","uploadParams","category","documentName","description","client_id","authClient","uploadDocument","docError","message","includes","results","Promise","all","createClient","warningMessage","processed","warn","insert","noDataError","SERVER","newClient","documentResult","errorMessage","clientData","updateClient","updates","userUpdates","Object","keys","forEach","key","typedKey","existingClient","existingError","update","updatedClient","fetchedData","fetchError","deleteClient","delete","checkClientExists","getClientCount","head"],"sources":["/Users/diegogg98/NEW CRM MAR18/src/services/clientService.ts"],"sourcesContent":["import { supabase, getAuthenticatedClient, getServiceClient } from \"../lib/supabaseClient\";\nimport { TABLES } from \"../utils/constants/tables\";\nimport * as documentService from './documentService';\nimport { Client, ClientDocument } from \"../types/client\";\nimport { \n  ErrorType, \n  createAppError, \n  logError, \n  handleApiError, \n  isRlsViolation,\n  createRlsViolationError,\n  createNoEffectError\n} from '../utils/errorHandling';\nimport { parseNumericString, processNumericField } from '../utils/numberFormatting';\nimport { uploadClientDocuments as uploadDocs } from '../utils/documentUpload';\n\n// Re-exportamos las interfaces para mantener compatibilidad\nexport type { Client, ClientDocument };\n\nexport interface ClientFilter {\n  searchQuery?: string;\n  advisor_id?: string;\n  company_id?: string;\n  dateFrom?: string;\n  dateTo?: string;\n  page?: number;\n  pageSize?: number;\n}\n\nconst USERS_TABLE = 'users';\n\nconst mapUserToClient = (userData: any): Client => {\n  if (!userData) {\n    console.error('Error: userData is undefined in mapUserToClient');\n    throw new Error('No se pudo procesar la información del cliente, los datos son inválidos');\n  }\n  \n  // Generar el nombre completo a partir de los componentes del nombre\n  const fullName = userData.name || [\n    userData.first_name,\n    userData.paternal_surname,\n    userData.maternal_surname\n  ].filter(Boolean).join(' ');\n  \n  // Crear el objeto cliente con todos los campos de la base de datos\n  const client: Client = {\n    id: userData.id,\n    created_at: userData.created_at,\n    last_login: userData.last_login,\n    name: fullName, // Campo calculado/virtual - no existe en la base de datos\n    first_name: userData.first_name,\n    paternal_surname: userData.paternal_surname,\n    maternal_surname: userData.maternal_surname,\n    email: userData.email,\n    phone: userData.phone,\n    birth_date: userData.birth_date,\n    company_id: userData.company_id,\n    rfc: userData.rfc,\n    curp: userData.curp,\n    advisor_id: userData.advisor_id,\n    address: userData.address,\n    city: userData.city,\n    state: userData.state,\n    postal_code: userData.postal_code,\n    gender: userData.gender,\n    marital_status: userData.marital_status,\n    employment_type: userData.employment_type,\n    employment_years: userData.employment_years,\n    monthly_income: userData.monthly_income,\n    additional_income: userData.additional_income,\n    monthly_expenses: userData.monthly_expenses,\n    other_loan_balances: userData.other_loan_balances,\n    bank_name: userData.bank_name,\n    bank_clabe: userData.bank_clabe,\n    bank_account_number: userData.bank_account_number,\n    bank_account_type: userData.bank_account_type,\n    bank_account_origin: userData.bank_account_origin,\n    street_number_ext: userData.street_number_ext,\n    street_number_int: userData.street_number_int,\n    neighborhood: userData.neighborhood,\n    home_phone: userData.home_phone,\n    birth_state: userData.birth_state,\n    nationality: userData.nationality,\n    job_position: userData.job_position,\n    employer_name: userData.employer_name,\n    employer_phone: userData.employer_phone,\n    employer_address: userData.employer_address,\n    employer_activity: userData.employer_activity,\n    mortgage_payment: userData.mortgage_payment,\n    rent_payment: userData.rent_payment,\n    dependent_persons: userData.dependent_persons,\n    income_frequency: userData.income_frequency,\n    payment_method: userData.payment_method,\n    credit_purpose: userData.credit_purpose,\n    spouse_paternal_surname: userData.spouse_paternal_surname,\n    spouse_maternal_surname: userData.spouse_maternal_surname,\n    reference1_name: userData.reference1_name,\n    reference1_relationship: userData.reference1_relationship,\n    reference1_address: userData.reference1_address,\n    reference1_phone: userData.reference1_phone,\n    reference2_name: userData.reference2_name,\n    reference2_relationship: userData.reference2_relationship,\n    reference2_address: userData.reference2_address,\n    reference2_phone: userData.reference2_phone,\n  };\n  \n  return client;\n};\n\nexport const getClients = async (filters?: ClientFilter) => {\n  try {\n    // Usamos el cliente de servicio para evitar problemas de autenticación\n    const serviceClient = getServiceClient();\n    \n    let query = serviceClient.from(USERS_TABLE)\n      .select('id, email, first_name, paternal_surname, maternal_surname, phone, company_id, created_at, birth_date, rfc, curp, advisor_id, address, city, state, postal_code, gender, marital_status, employment_type, employment_years, monthly_income, additional_income, monthly_expenses, other_loan_balances, bank_name, bank_clabe, bank_account_number, bank_account_type, bank_account_origin, street_number_ext, street_number_int, neighborhood, home_phone, birth_state, nationality, job_position, employer_name, employer_phone, employer_address, employer_activity, mortgage_payment, rent_payment, dependent_persons, income_frequency, payment_method, credit_purpose, spouse_paternal_surname, spouse_maternal_surname, reference1_name, reference1_relationship, reference1_address, reference1_phone, reference2_name, reference2_relationship, reference2_address, reference2_phone, last_login', { count: 'exact' });\n\n    if (filters) {\n      if (filters.advisor_id) {\n        query = query.eq('advisor_id', filters.advisor_id);\n      }\n\n      if (filters.company_id) {\n        query = query.eq('company_id', filters.company_id);\n      }\n\n      if (filters.dateFrom) {\n        query = query.gte('created_at', filters.dateFrom);\n      }\n\n      if (filters.dateTo) {\n        query = query.lte('created_at', filters.dateTo);\n      }\n\n      if (filters.searchQuery) {\n        query = query.or(\n          `first_name.ilike.%${filters.searchQuery}%,paternal_surname.ilike.%${filters.searchQuery}%,maternal_surname.ilike.%${filters.searchQuery}%,email.ilike.%${filters.searchQuery}%,phone.ilike.%${filters.searchQuery}%,rfc.ilike.%${filters.searchQuery}%,curp.ilike.%${filters.searchQuery}%`\n        );\n      }\n\n      if (filters.page !== undefined && filters.pageSize) {\n        const from = filters.page * filters.pageSize;\n        const to = from + filters.pageSize - 1;\n        query = query.range(from, to);\n      }\n    }\n\n    query = query.order('created_at', { ascending: false });\n\n    const { data, error, count } = await query;\n\n    if (error) {\n      logError(error, 'getClients', { filters });\n      throw handleApiError(error);\n    }\n\n    const clients = data ? data.map(mapUserToClient) : [];\n\n    return {\n      clients,\n      totalCount: count || 0\n    };\n  } catch (error) {\n    logError(error, 'getClients', { filters });\n    throw handleApiError(error);\n  }\n};\n\nexport const getClientById = async (id: string) => {\n  try {\n    // Usamos el cliente de servicio para evitar problemas de autenticación\n    const serviceClient = getServiceClient();\n    \n    const { data, error } = await serviceClient\n      .from(USERS_TABLE)\n      .select('id, email, first_name, paternal_surname, maternal_surname, phone, company_id, created_at, birth_date, rfc, curp, advisor_id, address, city, state, postal_code, gender, marital_status, employment_type, employment_years, monthly_income, additional_income, monthly_expenses, other_loan_balances, bank_name, bank_clabe, bank_account_number, bank_account_type, bank_account_origin, street_number_ext, street_number_int, neighborhood, home_phone, birth_state, nationality, job_position, employer_name, employer_phone, employer_address, employer_activity, mortgage_payment, rent_payment, dependent_persons, income_frequency, payment_method, credit_purpose, spouse_paternal_surname, spouse_maternal_surname, reference1_name, reference1_relationship, reference1_address, reference1_phone, reference2_name, reference2_relationship, reference2_address, reference2_phone, last_login')\n      .eq('id', id)\n      .single();\n\n    if (error) {\n      logError(error, 'getClientById', { clientId: id });\n      throw handleApiError(error);\n    }\n\n    if (!data) {\n      const notFoundError = createAppError(\n        ErrorType.NOT_FOUND,\n        `No se encontró cliente con ID: ${id}`\n      );\n      logError(notFoundError, 'getClientById', { clientId: id });\n      throw notFoundError;\n    }\n\n    return mapUserToClient(data);\n  } catch (error) {\n    logError(error, 'getClientById', { clientId: id });\n    throw handleApiError(error);\n  }\n};\n\nfunction escapeSQLString(str: string) {\n  if (!str) return '';\n  return str.replace(/'/g, \"''\");\n}\n\nexport const getClientApplications = async (clientId: string) => {\n  try {\n    const client = await getClientById(clientId).catch(err => {\n      console.error(`Error obteniendo cliente con ID ${clientId}:`, err);\n      throw handleApiError(err);\n    });\n    \n    if (!client) {\n      const notFoundError = createAppError(\n        ErrorType.NOT_FOUND,\n        `El cliente no existe`\n      );\n      logError(notFoundError, 'getClientApplications', { clientId });\n      return [];\n    }\n    \n    // Construir la consulta con el nombre del cliente\n    const query = `\n      SELECT * FROM ${TABLES.APPLICATIONS}\n      WHERE client_name = '${escapeSQLString(client.name || '')}'\n      ORDER BY created_at DESC\n    `;\n    \n    console.log(`Ejecutando consulta para obtener aplicaciones del cliente ${clientId}:`, query);\n    \n    // Utilizamos el servicio de consulta SQL directo que evita problemas de RLS\n    const executeQuery = async (query: string) => {\n      try {\n        const response = await fetch('http://localhost:3100/query', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({ query: query }),\n        });\n        \n        if (!response.ok) {\n          throw new Error(`Error en la respuesta HTTP: ${response.status} ${response.statusText}`);\n        }\n        \n        const result = await response.json();\n        \n        if (result.error) {\n          console.error('Error en la consulta SQL:', result.error);\n          throw new Error(result.error);\n        }\n        \n        return result.data || [];\n      } catch (error) {\n        console.error('Error ejecutando la consulta:', error);\n        throw error;\n      }\n    };\n    \n    const data = await executeQuery(query);\n    console.log(`Aplicaciones encontradas para el cliente ${clientId}:`, data.length);\n    return data;\n  } catch (error) {\n    logError(error, 'getClientApplications', { clientId });\n    console.error(`Error completo al obtener aplicaciones para cliente ${clientId}:`, error);\n    // Devolvemos un array vacío en caso de error para no interrumpir el flujo\n    return [];\n  }\n};\n\nexport const uploadClientDocuments = async (\n  clientId: string, \n  documents: ClientDocument[],\n  userId: string\n): Promise<documentService.Document[]> => {\n  if (!clientId) {\n    console.error('Client ID is required for uploading documents');\n    throw new Error('El ID del cliente es requerido para subir documentos');\n  }\n\n  // Verificar que se proporcionaron documentos válidos\n  if (!documents || !Array.isArray(documents) || documents.length === 0) {\n    console.error('No valid documents provided for upload');\n    throw new Error('No se proporcionaron documentos válidos para subir');\n  }\n\n  if (!userId) {\n    console.error('User ID is required for uploading documents');\n    throw new Error('Se requiere el ID del usuario para subir documentos');\n  }\n\n  try {\n    // Obtener cliente con permisos de servicio para operaciones que requieren más privilegios\n    const serviceClient = getServiceClient();\n    \n    // Asegurarse de que el bucket de almacenamiento exista\n    await documentService.ensureStorageBucketExists(serviceClient);\n\n    // Intentar subir cada documento\n    const uploadPromises = documents.map(async (document) => {\n      try {\n        // Verificar que el documento tenga datos válidos\n        if (!document.file || !document.name) {\n          console.error('Invalid document data', document);\n          throw new Error(\n            'Datos de documento inválidos: se requiere archivo y nombre'\n          );\n        }\n\n        // Create a document upload request compatible with the document service\n        const uploadParams: documentService.UploadDocumentParams = {\n          file: document.file,\n          category: document.category,\n          documentName: document.name,\n          description: document.description,\n          userId: userId,\n          client_id: clientId,\n          authClient: serviceClient\n        };\n\n        // Subir el documento\n        return await documentService.uploadDocument(uploadParams);\n      } catch (docError: any) {\n        // Manejo de errores específicos de permisos RLS\n        if (docError.message && (\n            docError.message.includes('permission denied') || \n            docError.message.includes('not authorized') ||\n            docError.message.includes('row level security')\n          )) {\n          console.error('Permission error when uploading document:', docError);\n          throw new Error('No tienes permiso para subir documentos para este cliente. Verifica tus permisos.');\n        }\n        \n        // Registrar el error pero permitir que otros uploads continúen\n        console.error(`Error uploading document for client ${clientId}:`, docError);\n        throw docError;\n      }\n    });\n\n    const results = await Promise.all(uploadPromises);\n    \n    return results;\n  } catch (error) {\n    logError(error, 'uploadClientDocuments', { clientId });\n    throw handleApiError(error);\n  }\n};\n\nexport const createClient = async (client: Omit<Client, 'id' | 'created_at'>, documents?: ClientDocument[], userId?: string) => {\n  try {\n    // Create a copy to avoid modifying the original object\n    const userData = {\n      email: client.email,\n      first_name: client.first_name || '',\n      paternal_surname: client.paternal_surname || '',\n      maternal_surname: client.maternal_surname || '',\n      phone: client.phone,\n      birth_date: client.birth_date,\n      company_id: client.company_id,\n      rfc: client.rfc,\n      curp: client.curp,\n      advisor_id: client.advisor_id,\n      address: client.address,\n      city: client.city,\n      state: client.state,\n      postal_code: client.postal_code,\n      gender: client.gender,\n      marital_status: client.marital_status,\n      employment_type: client.employment_type,\n      employment_years: client.employment_years,\n      monthly_income: client.monthly_income,\n      additional_income: client.additional_income,\n      monthly_expenses: client.monthly_expenses,\n      other_loan_balances: client.other_loan_balances,\n      bank_name: client.bank_name,\n      bank_clabe: client.bank_clabe,\n      bank_account_number: client.bank_account_number,\n      bank_account_type: client.bank_account_type,\n      bank_account_origin: client.bank_account_origin,\n      street_number_ext: client.street_number_ext,\n      street_number_int: client.street_number_int,\n      neighborhood: client.neighborhood,\n      home_phone: client.home_phone,\n      birth_state: client.birth_state,\n      nationality: client.nationality,\n      job_position: client.job_position,\n      employer_name: client.employer_name,\n      employer_phone: client.employer_phone,\n      employer_address: client.employer_address,\n      employer_activity: client.employer_activity,\n      mortgage_payment: client.mortgage_payment,\n      rent_payment: client.rent_payment,\n      dependent_persons: client.dependent_persons,\n      income_frequency: client.income_frequency,\n      payment_method: client.payment_method,\n      credit_purpose: client.credit_purpose,\n      spouse_paternal_surname: client.spouse_paternal_surname,\n      spouse_maternal_surname: client.spouse_maternal_surname,\n      reference1_name: client.reference1_name,\n      reference1_relationship: client.reference1_relationship,\n      reference1_address: client.reference1_address,\n      reference1_phone: client.reference1_phone,\n      reference2_name: client.reference2_name,\n      reference2_relationship: client.reference2_relationship,\n      reference2_address: client.reference2_address,\n      reference2_phone: client.reference2_phone,\n    };\n\n    // Asegurarse de que no se incluyan campos calculados\n    // Estos campos son calculados en la aplicación pero no existen en la base de datos\n    delete (userData as any).name;\n    delete (userData as any).warningMessage;\n\n    // Process numeric fields\n    if (userData.employment_years !== undefined) {\n      const processed = processNumericField(userData.employment_years);\n      userData.employment_years = processed === null ? undefined : processed;\n    }\n    if (userData.monthly_income !== undefined) {\n      const processed = processNumericField(userData.monthly_income);\n      userData.monthly_income = processed === null ? undefined : processed;\n    }\n    if (userData.additional_income !== undefined) {\n      const processed = processNumericField(userData.additional_income);\n      userData.additional_income = processed === null ? undefined : processed;\n    }\n    if (userData.monthly_expenses !== undefined) {\n      const processed = processNumericField(userData.monthly_expenses);\n      userData.monthly_expenses = processed === null ? undefined : processed;\n    }\n    if (userData.other_loan_balances !== undefined) {\n      const processed = processNumericField(userData.other_loan_balances);\n      userData.other_loan_balances = processed === null ? undefined : processed;\n    }\n\n    // Ensure company_id is present as it's required by the database schema\n    if (!userData.company_id) {\n      console.warn('No company_id provided when creating client - using default company');\n      userData.company_id = \"70b2aa97-a5b6-4b5e-91db-be8acbd3701a\"; // Default company (Herramental)\n    }\n\n    // Log sanitized data for debugging\n    console.log(`Creating client with sanitized data:`, JSON.stringify(userData));\n\n    // Get the service client for this operation to evitar problemas de autenticación\n    const serviceClient = getServiceClient();\n\n    const { data, error, count } = await serviceClient\n      .from(USERS_TABLE)\n      .insert([userData])\n      .select();\n\n    if (error) {\n      // Verificar si es una violación de RLS\n      if (isRlsViolation(error)) {\n        throw createRlsViolationError('crear', 'cliente', 'nuevo', error);\n      }\n      \n      logError(error, 'createClient');\n      throw handleApiError(error);\n    }\n\n    // Verify that rows were affected\n    if (!data || data.length === 0 || count === 0) {\n      const noDataError = createAppError(\n        ErrorType.SERVER,\n        'No se pudo crear el cliente. No se recibieron datos del servidor.'\n      );\n      logError(noDataError, 'createClient');\n      throw noDataError;\n    }\n\n    const newClient = mapUserToClient(data[0]);\n    let documentResult = null;\n    \n    if (documents && documents.length > 0 && userId && newClient.id) {\n      try {\n        console.log(`Uploading ${documents.length} documents for new client ${newClient.id}`);\n        \n        // Usar la versión mejorada de uploadClientDocuments de utils\n        documentResult = await uploadDocs(newClient.id, documents);\n        \n        // Check if any documents uploaded successfully\n        if (documentResult && documentResult.length > 0) {\n          console.log(`${documentResult.length} documents uploaded successfully during client creation`);\n        } else {\n          console.warn(`No documents were successfully uploaded during client creation`);\n          newClient.warningMessage = 'Se creó el cliente, pero no se pudieron subir los documentos. Puede intentar agregarlos nuevamente más tarde.';\n        }\n      } catch (docError) {\n        console.error('Error uploading documents during client creation:', docError);\n        \n        // Información más detallada del error\n        const errorMessage = docError instanceof Error ? docError.message : 'Error desconocido';\n        console.error(`Error detail: ${errorMessage}`);\n        \n        // Continue with client creation but add warning\n        newClient.warningMessage = `Se creó el cliente, pero hubo un problema al subir los documentos: ${errorMessage}. Puede intentar agregarlos nuevamente más tarde.`;\n      }\n    }\n\n    return newClient;\n  } catch (error) {\n    logError(error, 'createClient', { clientData: client });\n    throw handleApiError(error);\n  }\n};\n\nexport const updateClient = async (id: string, updates: Partial<Client>, documents?: ClientDocument[], userId?: string) => {\n  try {\n    console.log(`Starting client update for ID ${id}`, updates);\n    \n    // Create a copy to avoid modifying the original object\n    const userUpdates: any = { ...updates };\n    \n    // Eliminar campos calculados o virtuales que no existen en la base de datos\n    // El campo 'name' es calculado en mapUserToClient pero no existe en la tabla\n    delete userUpdates.name;\n    delete userUpdates.warningMessage;\n    \n    // Process specific numeric fields\n    if ('employment_years' in updates) {\n      const processed = processNumericField(updates.employment_years);\n      userUpdates.employment_years = processed === null ? undefined : processed;\n    }\n    if ('monthly_income' in updates) {\n      const processed = processNumericField(updates.monthly_income);\n      userUpdates.monthly_income = processed === null ? undefined : processed;\n    }\n    if ('additional_income' in updates) {\n      const processed = processNumericField(updates.additional_income);\n      userUpdates.additional_income = processed === null ? undefined : processed;\n    }\n    if ('monthly_expenses' in updates) {\n      const processed = processNumericField(updates.monthly_expenses);\n      userUpdates.monthly_expenses = processed === null ? undefined : processed;\n    }\n    if ('other_loan_balances' in updates) {\n      const processed = processNumericField(updates.other_loan_balances);\n      userUpdates.other_loan_balances = processed === null ? undefined : processed;\n    }\n    if ('mortgage_payment' in updates) {\n      const processed = processNumericField(updates.mortgage_payment);\n      userUpdates.mortgage_payment = processed === null ? undefined : processed;\n    }\n    if ('rent_payment' in updates) {\n      const processed = processNumericField(updates.rent_payment);\n      userUpdates.rent_payment = processed === null ? undefined : processed;\n    }\n    if ('dependent_persons' in updates) {\n      const processed = processNumericField(updates.dependent_persons);\n      userUpdates.dependent_persons = processed === null ? undefined : processed;\n    }\n\n    // Remove undefined fields\n    Object.keys(userUpdates).forEach(key => {\n      const typedKey = key as keyof typeof userUpdates;\n      if (userUpdates[typedKey] === undefined) {\n        delete userUpdates[typedKey];\n      }\n    });\n\n    console.log(`Updating client ${id} with sanitized data:`, JSON.stringify(userUpdates));\n\n    // Get the service client for this operation to evitar problemas de permisos\n    const serviceClient = getServiceClient();\n\n    // First, verify the client exists\n    const { data: existingClient, error: existingError } = await serviceClient\n      .from(USERS_TABLE)\n      .select('id')\n      .eq('id', id)\n      .single();\n\n    if (existingError || !existingClient) {\n      const notFoundError = createAppError(\n        ErrorType.NOT_FOUND,\n        `No se encontró el cliente con ID ${id}. Verifique que el cliente exista.`\n      );\n      logError(notFoundError, 'updateClient', { clientId: id });\n      throw notFoundError;\n    }\n\n    // Perform the update with the service client\n    const { data, error, count } = await serviceClient\n      .from(USERS_TABLE)\n      .update(userUpdates)\n      .eq('id', id)\n      .select();\n\n    if (error) {\n      // Verificar si es una violación de RLS\n      if (isRlsViolation(error)) {\n        throw createRlsViolationError('actualizar', 'cliente', id, error);\n      }\n      \n      logError(error, 'updateClient', { clientId: id });\n      throw handleApiError(error);\n    }\n\n    // Verify that the update affected rows\n    if (!data || data.length === 0 || count === 0) {\n      console.warn(`Update operation didn't affect any rows for client ${id}`);\n      throw createNoEffectError('update', 'cliente', id);\n    }\n\n    let updatedClient: Client;\n\n    if (!data || data.length === 0) {\n      console.log(`No data returned when updating client with ID ${id}, fetching client data separately`);\n      \n      // Fallback: fetch the client data separately\n      const { data: fetchedData, error: fetchError } = await serviceClient\n        .from(USERS_TABLE)\n        .select('*')\n        .eq('id', id)\n        .single();\n      \n      if (fetchError) {\n        console.error('Error fetching updated client:', fetchError);\n        throw fetchError;\n      }\n      \n      updatedClient = mapUserToClient(fetchedData);\n    } else {\n      updatedClient = mapUserToClient(data[0]);\n    }\n    \n    let documentResult = null;\n    \n    // Upload documents if provided\n    if (documents && documents.length > 0 && userId) {\n      try {\n        console.log(`Uploading ${documents.length} documents for client ${id}`);\n        \n        // Usar la versión mejorada de uploadClientDocuments de utils\n        documentResult = await uploadDocs(id, documents);\n        \n        // Check if any documents failed to upload\n        if (documentResult && documentResult.length > 0) {\n          console.log(`${documentResult.length} documents uploaded successfully during client update`);\n        } else {\n          console.warn(`No documents were successfully uploaded during client update`);\n          updatedClient.warningMessage = 'Se actualizó el cliente, pero no se pudieron subir los documentos. Puede intentar agregarlos nuevamente más tarde.';\n        }\n      } catch (docError) {\n        console.error(`Error uploading documents for client ${id}:`, docError);\n        \n        // Información más detallada del error\n        const errorMessage = docError instanceof Error ? docError.message : 'Error desconocido';\n        console.error(`Error detail: ${errorMessage}`);\n        \n        // Continue with client update but add warning\n        updatedClient.warningMessage = `Se actualizó el cliente, pero hubo un problema al subir los documentos: ${errorMessage}. Puede intentar agregarlos nuevamente más tarde.`;\n      }\n    }\n\n    console.log(`Client update complete for ID ${id}`);\n    return updatedClient;\n  } catch (error) {\n    logError(error, 'updateClient', { clientId: id, updates });\n    throw handleApiError(error);\n  }\n};\n\nexport const deleteClient = async (id: string) => {\n  try {\n    // Get the service client for this operation\n    const serviceClient = getServiceClient();\n    \n    const { error, count } = await serviceClient\n      .from(USERS_TABLE)\n      .delete()\n      .eq('id', id);\n\n    if (error) {\n      // Verificar si es una violación de RLS\n      if (isRlsViolation(error)) {\n        throw createRlsViolationError('eliminar', 'cliente', id, error);\n      }\n      \n      logError(error, 'deleteClient', { clientId: id });\n      throw handleApiError(error);\n    }\n\n    // Verify that rows were affected\n    if (count === 0) {\n      console.warn(`Delete operation didn't affect any rows for client ${id}`);\n      throw createNoEffectError('delete', 'cliente', id);\n    }\n\n    return true;\n  } catch (error) {\n    logError(error, 'deleteClient', { clientId: id });\n    throw handleApiError(error);\n  }\n};\n\nexport const checkClientExists = async (email: string, rfc?: string) => {\n  try {\n    const serviceClient = getServiceClient();\n    \n    let query = serviceClient\n      .from(USERS_TABLE)\n      .select('id, email, rfc')\n      .eq('email', email);\n\n    if (rfc) {\n      query = query.or(`rfc.eq.${rfc}`);\n    }\n\n    const { data, error } = await query;\n\n    if (error) {\n      logError(error, 'checkClientExists', { email, rfc });\n      throw handleApiError(error);\n    }\n\n    return data?.length > 0;\n  } catch (error) {\n    logError(error, 'checkClientExists', { email, rfc });\n    throw handleApiError(error);\n  }\n};\n\nexport const getClientCount = async (filters?: ClientFilter) => {\n  try {\n    const serviceClient = getServiceClient();\n    \n    let query = serviceClient\n      .from(USERS_TABLE)\n      .select('*', { count: 'exact', head: true });\n\n    if (filters) {\n      if (filters.advisor_id) {\n        query = query.eq('advisor_id', filters.advisor_id);\n      }\n\n      if (filters.company_id) {\n        query = query.eq('company_id', filters.company_id);\n      }\n\n      if (filters.dateFrom) {\n        query = query.gte('created_at', filters.dateFrom);\n      }\n\n      if (filters.dateTo) {\n        query = query.lte('created_at', filters.dateTo);\n      }\n    }\n\n    const { count, error } = await query;\n\n    if (error) {\n      logError(error, 'getClientCount', { filters });\n      throw handleApiError(error);\n    }\n\n    return count || 0;\n  } catch (error) {\n    logError(error, 'getClientCount', { filters });\n    throw handleApiError(error);\n  }\n}; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}