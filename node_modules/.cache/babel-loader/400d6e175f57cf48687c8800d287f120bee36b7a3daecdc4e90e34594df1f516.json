{"ast":null,"code":"import { getServiceClient } from '../lib/supabaseClient';\nimport { TABLES } from './constants/tables';\n\n/**\n * Verifica si una tabla existe en Supabase\n * @param tableName Nombre de la tabla a verificar\n * @returns Booleano indicando si la tabla existe\n */\nconst checkTableExists = async tableName => {\n  try {\n    const serviceClient = getServiceClient();\n\n    // Intentamos obtener 1 registro de la tabla\n    const {\n      error\n    } = await serviceClient.from(tableName).select('*').limit(1);\n\n    // Si no hay error, la tabla existe\n    return !error;\n  } catch (error) {\n    console.error(`Error verificando si la tabla ${tableName} existe:`, error);\n    return false;\n  }\n};\n\n/**\n * Crea la tabla de documentos en Supabase\n * \n * NOTA: Esta función solo funciona si el usuario tiene permisos para crear tablas.\n * En la mayoría de los casos, será necesario crear la tabla manualmente desde la\n * interfaz de Supabase o mediante SQL directo.\n */\nconst createDocumentsTable = async () => {\n  try {\n    console.log(`Intentando crear la tabla ${TABLES.DOCUMENTS}...`);\n    const serviceClient = getServiceClient();\n\n    // Verificar si la tabla ya existe\n    const tableExists = await checkTableExists(TABLES.DOCUMENTS);\n    if (tableExists) {\n      console.log(`La tabla ${TABLES.DOCUMENTS} ya existe. No es necesario crearla.`);\n      return true;\n    }\n\n    // Crear la tabla usando SQL directo\n    // Esto solo funcionará si el usuario tiene permisos para ejecutar SQL\n    const {\n      error\n    } = await serviceClient.rpc('execute_sql', {\n      query: `\n        CREATE TABLE IF NOT EXISTS ${TABLES.DOCUMENTS} (\n          id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n          file_name TEXT NOT NULL,\n          file_path TEXT,\n          file_type TEXT,\n          file_size BIGINT,\n          category TEXT,\n          application_id UUID REFERENCES ${TABLES.APPLICATIONS}(id) ON DELETE CASCADE,\n          client_id UUID REFERENCES ${TABLES.CLIENTS}(id) ON DELETE CASCADE,\n          uploaded_by_user_id UUID,\n          is_verified BOOLEAN DEFAULT FALSE,\n          verified_by UUID,\n          verified_at TIMESTAMP WITH TIME ZONE\n        );\n        \n        -- Añadir políticas RLS\n        ALTER TABLE ${TABLES.DOCUMENTS} ENABLE ROW LEVEL SECURITY;\n        \n        -- Política para permitir lectura a usuarios autenticados\n        CREATE POLICY \"Users can view documents\" ON ${TABLES.DOCUMENTS}\n          FOR SELECT\n          TO authenticated\n          USING (true);\n          \n        -- Política para permitir inserción a usuarios autenticados\n        CREATE POLICY \"Users can insert documents\" ON ${TABLES.DOCUMENTS}\n          FOR INSERT\n          TO authenticated\n          WITH CHECK (true);\n          \n        -- Política para permitir actualización a usuarios autenticados\n        CREATE POLICY \"Users can update their own documents\" ON ${TABLES.DOCUMENTS}\n          FOR UPDATE\n          TO authenticated\n          USING (uploaded_by_user_id = auth.uid() OR \n                (client_id IN (SELECT id FROM ${TABLES.CLIENTS} WHERE advisor_id = auth.uid())) OR\n                (application_id IN (SELECT id FROM ${TABLES.APPLICATIONS} WHERE advisor_id = auth.uid())));\n      `\n    });\n    if (error) {\n      console.error(`Error al crear la tabla ${TABLES.DOCUMENTS}:`, error);\n      return false;\n    }\n    console.log(`Tabla ${TABLES.DOCUMENTS} creada correctamente.`);\n    return true;\n  } catch (error) {\n    console.error(`Error al crear la tabla ${TABLES.DOCUMENTS}:`, error);\n    return false;\n  }\n};\n\n/**\n * Función principal que verifica y crea las tablas necesarias\n */\nexport const ensureTablesExist = async () => {\n  console.log('Verificando tablas necesarias...');\n\n  // Verificar y crear tabla de documentos\n  const documentsExists = await checkTableExists(TABLES.DOCUMENTS);\n  if (!documentsExists) {\n    console.warn(`La tabla ${TABLES.DOCUMENTS} no existe. Intentando crearla...`);\n    await createDocumentsTable();\n  } else {\n    console.log(`La tabla ${TABLES.DOCUMENTS} existe correctamente.`);\n  }\n\n  // Aquí puedes agregar verificaciones para otras tablas según sea necesario\n\n  console.log('Verificación de tablas completada.');\n};\n\n// Si este archivo se ejecuta directamente, verificar tablas\nif (require.main === module) {\n  ensureTablesExist().then(() => console.log('Proceso finalizado.')).catch(error => console.error('Error en el proceso:', error));\n}\nexport default {\n  checkTableExists,\n  createDocumentsTable,\n  ensureTablesExist\n};","map":{"version":3,"names":["getServiceClient","TABLES","checkTableExists","tableName","serviceClient","error","from","select","limit","console","createDocumentsTable","log","DOCUMENTS","tableExists","rpc","query","APPLICATIONS","CLIENTS","ensureTablesExist","documentsExists","warn","require","main","module","then","catch"],"sources":["/Users/diegogg98/NEW CRM MAR18/src/utils/createTables.ts"],"sourcesContent":["import { getServiceClient } from '../lib/supabaseClient';\nimport { TABLES } from './constants/tables';\n\n/**\n * Verifica si una tabla existe en Supabase\n * @param tableName Nombre de la tabla a verificar\n * @returns Booleano indicando si la tabla existe\n */\nconst checkTableExists = async (tableName: string): Promise<boolean> => {\n  try {\n    const serviceClient = getServiceClient();\n    \n    // Intentamos obtener 1 registro de la tabla\n    const { error } = await serviceClient\n      .from(tableName)\n      .select('*')\n      .limit(1);\n    \n    // Si no hay error, la tabla existe\n    return !error;\n  } catch (error) {\n    console.error(`Error verificando si la tabla ${tableName} existe:`, error);\n    return false;\n  }\n};\n\n/**\n * Crea la tabla de documentos en Supabase\n * \n * NOTA: Esta función solo funciona si el usuario tiene permisos para crear tablas.\n * En la mayoría de los casos, será necesario crear la tabla manualmente desde la\n * interfaz de Supabase o mediante SQL directo.\n */\nconst createDocumentsTable = async () => {\n  try {\n    console.log(`Intentando crear la tabla ${TABLES.DOCUMENTS}...`);\n    \n    const serviceClient = getServiceClient();\n    \n    // Verificar si la tabla ya existe\n    const tableExists = await checkTableExists(TABLES.DOCUMENTS);\n    \n    if (tableExists) {\n      console.log(`La tabla ${TABLES.DOCUMENTS} ya existe. No es necesario crearla.`);\n      return true;\n    }\n    \n    // Crear la tabla usando SQL directo\n    // Esto solo funcionará si el usuario tiene permisos para ejecutar SQL\n    const { error } = await serviceClient.rpc('execute_sql', {\n      query: `\n        CREATE TABLE IF NOT EXISTS ${TABLES.DOCUMENTS} (\n          id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n          file_name TEXT NOT NULL,\n          file_path TEXT,\n          file_type TEXT,\n          file_size BIGINT,\n          category TEXT,\n          application_id UUID REFERENCES ${TABLES.APPLICATIONS}(id) ON DELETE CASCADE,\n          client_id UUID REFERENCES ${TABLES.CLIENTS}(id) ON DELETE CASCADE,\n          uploaded_by_user_id UUID,\n          is_verified BOOLEAN DEFAULT FALSE,\n          verified_by UUID,\n          verified_at TIMESTAMP WITH TIME ZONE\n        );\n        \n        -- Añadir políticas RLS\n        ALTER TABLE ${TABLES.DOCUMENTS} ENABLE ROW LEVEL SECURITY;\n        \n        -- Política para permitir lectura a usuarios autenticados\n        CREATE POLICY \"Users can view documents\" ON ${TABLES.DOCUMENTS}\n          FOR SELECT\n          TO authenticated\n          USING (true);\n          \n        -- Política para permitir inserción a usuarios autenticados\n        CREATE POLICY \"Users can insert documents\" ON ${TABLES.DOCUMENTS}\n          FOR INSERT\n          TO authenticated\n          WITH CHECK (true);\n          \n        -- Política para permitir actualización a usuarios autenticados\n        CREATE POLICY \"Users can update their own documents\" ON ${TABLES.DOCUMENTS}\n          FOR UPDATE\n          TO authenticated\n          USING (uploaded_by_user_id = auth.uid() OR \n                (client_id IN (SELECT id FROM ${TABLES.CLIENTS} WHERE advisor_id = auth.uid())) OR\n                (application_id IN (SELECT id FROM ${TABLES.APPLICATIONS} WHERE advisor_id = auth.uid())));\n      `\n    });\n    \n    if (error) {\n      console.error(`Error al crear la tabla ${TABLES.DOCUMENTS}:`, error);\n      return false;\n    }\n    \n    console.log(`Tabla ${TABLES.DOCUMENTS} creada correctamente.`);\n    return true;\n  } catch (error) {\n    console.error(`Error al crear la tabla ${TABLES.DOCUMENTS}:`, error);\n    return false;\n  }\n};\n\n/**\n * Función principal que verifica y crea las tablas necesarias\n */\nexport const ensureTablesExist = async () => {\n  console.log('Verificando tablas necesarias...');\n  \n  // Verificar y crear tabla de documentos\n  const documentsExists = await checkTableExists(TABLES.DOCUMENTS);\n  \n  if (!documentsExists) {\n    console.warn(`La tabla ${TABLES.DOCUMENTS} no existe. Intentando crearla...`);\n    await createDocumentsTable();\n  } else {\n    console.log(`La tabla ${TABLES.DOCUMENTS} existe correctamente.`);\n  }\n  \n  // Aquí puedes agregar verificaciones para otras tablas según sea necesario\n  \n  console.log('Verificación de tablas completada.');\n};\n\n// Si este archivo se ejecuta directamente, verificar tablas\nif (require.main === module) {\n  ensureTablesExist()\n    .then(() => console.log('Proceso finalizado.'))\n    .catch(error => console.error('Error en el proceso:', error));\n}\n\nexport default {\n  checkTableExists,\n  createDocumentsTable,\n  ensureTablesExist\n}; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}