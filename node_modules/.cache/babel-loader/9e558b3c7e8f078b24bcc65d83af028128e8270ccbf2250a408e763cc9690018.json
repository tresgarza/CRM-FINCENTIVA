{"ast":null,"code":"import React,{createContext,useContext,useState,useEffect,useRef}from'react';import{useAuth}from'./AuthContext';import NotificationPopup from'../components/ui/NotificationPopup';// Generate a proper UUID for notification IDs\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function generateUUID(){// Use a more standard implementation for UUID v4\nreturn'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){const r=Math.random()*16|0;const v=c==='x'?r:r&0x3|0x8;return v.toString(16);});}// For test notifications, use a valid UUID format - don't use app-timestamp\nfunction getTestApplicationId(){// Use a small set of real UUIDs as sample application IDs\nconst sampleIds=['110cc76a-1762-4df4-840e-a503fea9d7aa','220cc76a-1762-4df4-840e-a503fea9d7bb','330cc76a-1762-4df4-840e-a503fea9d7cc','440cc76a-1762-4df4-840e-a503fea9d7dd','550cc76a-1762-4df4-840e-a503fea9d7ee'];// Pick a random ID from the sample list\nreturn sampleIds[Math.floor(Math.random()*sampleIds.length)];}// Enum for notification types\nexport let NotificationType=/*#__PURE__*/function(NotificationType){NotificationType[\"INFO\"]=\"info\";NotificationType[\"SUCCESS\"]=\"success\";NotificationType[\"WARNING\"]=\"warning\";NotificationType[\"ERROR\"]=\"error\";NotificationType[\"NEW_APPLICATION\"]=\"new_application\";NotificationType[\"APPROVAL_REQUIRED\"]=\"approval_required\";NotificationType[\"NEW_MESSAGE\"]=\"new_message\";NotificationType[\"APPLICATION_STATUS_UPDATED\"]=\"application_status_updated\";NotificationType[\"APPLICATION_COMMENT\"]=\"application_comment\";return NotificationType;}({});// Interfaces\nexport const NotificationContext=/*#__PURE__*/createContext(undefined);export const useNotifications=()=>{const context=useContext(NotificationContext);if(context===undefined){throw new Error('useNotifications must be used within a NotificationProvider');}return context;};export const NotificationProvider=_ref=>{let{children}=_ref;const{user}=useAuth();const[notifications,setNotifications]=useState([]);const[unreadCount,setUnreadCount]=useState(0);const[soundEnabled,setSoundEnabled]=useState(true);// Estado para la notificación emergente actual\nconst[currentPopup,setCurrentPopup]=useState(null);// Referencia al ID del polling interval\nconst pollingIntervalRef=useRef(null);// State to keep track of already notified application IDs with timestamps\n// This helps prevent showing the same notification multiple times\nconst[notifiedApplications,setNotifiedApplications]=useState(new Map());// Referencia para evitar múltiples ejecuciones simultáneas\nconst checkingRef=useRef(false);// Reference to the latest known notification time\nconst lastNotificationTimeRef=useRef(new Date());// Avoid duplicate notifications by ensuring we have a minimum interval between checks\nconst lastCheckTimeRef=useRef(new Date());// Efecto para manejar la carga inicial de notificaciones y configurar el polling\nuseEffect(()=>{if(user){// Cargar notificaciones al inicio\nloadNotifications();// Cargar aplicaciones ya notificadas desde localStorage\ntry{const storedNotifications=localStorage.getItem('notified_application_ids');if(storedNotifications){const parsedData=JSON.parse(storedNotifications);// Handle both old format (array) and new format (object with timestamps)\nif(Array.isArray(parsedData)){// Old format - convert to new Map with current timestamp\nconst notifiedMap=new Map();const now=Date.now();parsedData.forEach(id=>{notifiedMap.set(id,now);});setNotifiedApplications(notifiedMap);// Re-save with the new format\nsaveNotifiedApplications(notifiedMap);console.log(`Converted ${notifiedMap.size} notified application IDs from old format to new format`);}else if(typeof parsedData==='object'){// New format - convert object to Map\nconst notifiedMap=new Map();Object.entries(parsedData).forEach(_ref2=>{let[id,timestamp]=_ref2;notifiedMap.set(id,timestamp);});setNotifiedApplications(notifiedMap);console.log(`Loaded ${notifiedMap.size} notified application IDs from localStorage`);}}else{console.log('No previously notified applications found in localStorage');}// Limpiar notificaciones antiguas (más de 48 horas)\ncleanupOldNotifications();}catch(error){console.error('Error loading notified applications:',error);// Reset if there's an error\nsetNotifiedApplications(new Map());}// Set the initial last check time to now\nlastCheckTimeRef.current=new Date();// Set the initial last notification time to 10 seconds ago to avoid immediate checks\nlastNotificationTimeRef.current=new Date(Date.now()-10000);// Wait 5 seconds before first check to ensure UI is fully loaded\nconst initialCheckTimeout=setTimeout(()=>{// Primero obtenemos la fecha de la última aplicación para inicializar el sistema\ninitializeWithLastApplicationTimestamp();// Configurar polling para verificar nuevas notificaciones cada 30 seconds\n// Utilizamos un intervalo más corto para estar más atentos a nuevas solicitudes\npollingIntervalRef.current=setInterval(()=>{const now=new Date();const timeSinceLastCheck=now.getTime()-lastCheckTimeRef.current.getTime();const timeSinceLastNotification=now.getTime()-lastNotificationTimeRef.current.getTime();// Only check if:\n// 1. It's been at least 15 seconds since last check AND\n// 2. It's been at least 5 seconds since showing a notification\nif(timeSinceLastCheck>15000&&timeSinceLastNotification>5000){checkForNewNotifications();}else{console.log(`Skipping notification check (last check: ${(timeSinceLastCheck/1000).toFixed(1)}s ago, last notification: ${(timeSinceLastNotification/1000).toFixed(1)}s ago)`);}},20000);},5000);// Limpiar el intervalo cuando el componente se desmonte\nreturn()=>{if(pollingIntervalRef.current){clearInterval(pollingIntervalRef.current);}clearTimeout(initialCheckTimeout);};}},[user]);// Inicializar con el timestamp de la última aplicación\nconst initializeWithLastApplicationTimestamp=async()=>{try{// Obtener la última aplicación para usarla como referencia inicial\nconst response=await fetch('http://localhost:3100/query',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:`\n            SELECT id, created_at, application_type, client_name, company_name, status, amount\n            FROM applications \n            ORDER BY created_at DESC\n            LIMIT 1\n          `})});if(!response.ok){throw new Error('Error querying most recent application');}const data=await response.json();if(data.data&&data.data.length>0){const lastApp=data.data[0];const lastAppId=lastApp.id;const lastAppCreatedAt=new Date(lastApp.created_at);console.log(`System initialized with reference to last application: ${lastAppId} created at ${lastAppCreatedAt.toISOString()}`);// Marcar la aplicación más reciente como ya notificada para evitar duplicados al inicio\nif(!notifiedApplications.has(lastAppId)){const appMetadata={notifiedAt:new Date().toISOString(),notificationType:'initialization',applicationType:lastApp.application_type,amount:lastApp.amount,clientName:lastApp.client_name,companyName:lastApp.company_name,status:lastApp.status};markApplicationAsNotified(lastAppId,lastApp.created_at,appMetadata);}}// Realizar la primera verificación de notificaciones\ncheckForNewNotifications();}catch(error){console.error('Error initializing with last application timestamp:',error);// Si falla, aún intentamos la primera verificación\ncheckForNewNotifications();}};// Cálculo de notificaciones no leídas\nuseEffect(()=>{const count=notifications.filter(notification=>!notification.read).length;setUnreadCount(count);},[notifications]);// Cargar notificaciones del almacenamiento local o del servidor\nconst loadNotifications=async()=>{try{// En un escenario real, aquí se cargarían las notificaciones del servidor\n// Por ahora, usaremos el localStorage como ejemplo\nconst storedNotifications=localStorage.getItem('notifications');if(storedNotifications){const parsed=JSON.parse(storedNotifications);setNotifications(parsed.map(n=>({...n,createdAt:new Date(n.createdAt)})));}}catch(error){console.error('Error loading notifications:',error);}};// Save notified applications with timestamps to localStorage\nconst saveNotifiedApplications=notifiedMap=>{try{// Convert Map to object for storage\nconst notifiedObject={};notifiedMap.forEach((timestamp,id)=>{notifiedObject[id]=timestamp;});localStorage.setItem('notified_application_ids',JSON.stringify(notifiedObject));console.log(`Saved ${notifiedMap.size} notified application IDs to localStorage`);}catch(error){console.error('Error saving notified applications:',error);}};// Función para limpiar notificaciones antiguas\nconst cleanupOldNotifications=()=>{try{const now=Date.now();const twentyFourHoursAgo=now-24*60*60*1000;// 24 horas en milisegundos\nlet totalCount=0;let cleanedCount=0;// Crear un nuevo mapa para guardar solo las notificaciones más recientes\nconst updatedNotifications=new Map();notifiedApplications.forEach((timestamp,id)=>{totalCount++;if(timestamp>twentyFourHoursAgo){// Mantener solo las notificaciones de las últimas 24 horas\nupdatedNotifications.set(id,timestamp);}else{cleanedCount++;}});if(cleanedCount>0){console.log(`Cleaned up ${cleanedCount} old notification records (${totalCount-cleanedCount} retained)`);setNotifiedApplications(updatedNotifications);saveNotifiedApplications(updatedNotifications);}else if(totalCount>0){console.log(`No old notifications to clean up (${totalCount} notifications are all within 24 hours)`);}}catch(error){console.error('Error cleaning up old notifications:',error);}};// Marcar una aplicación como notificada\nconst markApplicationAsNotified=(applicationId,createdTimestamp,metadata)=>{// Check if already marked as notified\nif(notifiedApplications.has(applicationId)){console.log(`Application ${applicationId} already marked as notified (duplicate protection)`);return;// Already notified, don't do anything\n}try{let notificationTime;// If createdTimestamp is provided, use it to set notification time just after creation\nif(createdTimestamp){try{// Try to parse the creation timestamp\nconst creationTime=new Date(createdTimestamp);// Set notification time 1 second after creation to ensure proper ordering\nnotificationTime=creationTime.getTime()+1000;console.log(`Using application creation time for notification: ${creationTime.toISOString()}`);}catch(error){// If parsing fails, use current time as fallback\nconsole.warn(`Error parsing creation timestamp \"${createdTimestamp}\":`,error);notificationTime=Date.now();}}else{// If no timestamp provided, use current time\nnotificationTime=Date.now();}// Crear un objeto de metadatos para esta aplicación si no se proporcionó uno\nconst appMetadata=metadata||{notifiedAt:new Date(notificationTime).toISOString(),notificationType:'application'};// Save to the notified applications map\nconst updatedMap=new Map(notifiedApplications);updatedMap.set(applicationId,notificationTime);setNotifiedApplications(updatedMap);// Guardar también los metadatos si es necesario para futuras optimizaciones\ntry{const metadataKey=`notification_metadata_${applicationId}`;localStorage.setItem(metadataKey,JSON.stringify(appMetadata));}catch(error){console.warn('Error saving notification metadata:',error);}// Save to localStorage\nsaveNotifiedApplications(updatedMap);// Update last notification time\nlastNotificationTimeRef.current=new Date();console.log(`Marked application ${applicationId} as notified at ${new Date(notificationTime).toISOString()}`);}catch(error){console.error('Error marking application as notified:',error);}};// Función para obtener la consulta SQL optimizada según el tipo de aplicación más reciente\nconst getOptimizedQuery=async()=>{try{// Primero, verificar el tipo de la aplicación más reciente para optimizar la consulta\nconst typeCheckResponse=await fetch('http://localhost:3100/query',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:`\n            SELECT application_type\n            FROM applications \n            ORDER BY created_at DESC\n            LIMIT 1\n          `})});if(!typeCheckResponse.ok){console.warn('Error checking latest application type, using default query');return getDefaultQuery();}const typeData=await typeCheckResponse.json();if(!typeData.data||typeData.data.length===0){console.log('No applications found, using default query');return getDefaultQuery();}const latestType=typeData.data[0].application_type;console.log(`Latest application type: ${latestType}`);// Personalizar los campos según el tipo de aplicación\nlet additionalFields='';switch(latestType){case'selected_plans':// Para planes seleccionados, necesitamos plazo, tasa y pago mensual\nadditionalFields='';break;case'product_simulations':// Para simulaciones, podríamos necesitar campos específicos del producto\nadditionalFields='';break;case'cash_requests':// Para solicitudes de efectivo\nadditionalFields='';break;case'car_backed_loan_applications':case'auto_loan_applications':// Para préstamos de auto, podríamos necesitar datos del vehículo\nadditionalFields='';break;default:additionalFields='';}// Construir consulta con base en el tipo\nreturn`\n        SELECT id, client_name, application_type, company_name, created_at, status, \n               amount, term, interest_rate, monthly_payment, client_email, client_phone ${additionalFields}\n        FROM applications \n        WHERE created_at > NOW() - INTERVAL '30 seconds'\n        ORDER BY created_at DESC\n        LIMIT 5\n      `;}catch(error){console.error('Error building optimized query:',error);return getDefaultQuery();}};// Consulta predeterminada con campos básicos\nconst getDefaultQuery=()=>{return`\n      SELECT id, client_name, application_type, company_name, created_at, status, \n             amount, term, interest_rate, monthly_payment, client_email, client_phone\n      FROM applications \n      WHERE created_at > NOW() - INTERVAL '30 seconds'\n      ORDER BY created_at DESC\n      LIMIT 5\n    `;};const checkForNewNotifications=async()=>{// Record the check time immediately to prevent race conditions\nlastCheckTimeRef.current=new Date();// Avoid multiple executions at the same time\nif(checkingRef.current){console.log('Already checking for notifications');return;}// Make sure we don't have any lingering popups\nclearPopups();// Sincronizar con localStorage antes de verificar para evitar duplicados\ntry{const storedNotifications=localStorage.getItem('notified_application_ids');if(storedNotifications){const parsedData=JSON.parse(storedNotifications);if(typeof parsedData==='object'&&!Array.isArray(parsedData)){// Fusionar con las notificaciones actuales\nconst updatedMap=new Map(notifiedApplications);let hasChanges=false;Object.entries(parsedData).forEach(_ref3=>{let[id,timestamp]=_ref3;if(!updatedMap.has(id)){updatedMap.set(id,timestamp);hasChanges=true;}});if(hasChanges){console.log('Synchronized notification IDs from localStorage before checking');setNotifiedApplications(updatedMap);}}}}catch(error){console.error('Error synchronizing notifications from localStorage:',error);}checkingRef.current=true;console.log('Checking for new notifications...');try{// Convert notified IDs Map to array for logging\nconst notifiedIdsArray=Array.from(notifiedApplications.keys());console.log(`${notifiedIdsArray.length} already notified application IDs: ${notifiedIdsArray.join(', ').substring(0,200)}${notifiedIdsArray.length>5?'...':''}`);// Obtener consulta optimizada según tipo de aplicación\nconst optimizedQuery=await getOptimizedQuery();console.log('Using optimized query for latest application type');const response=await fetch('http://localhost:3100/query',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:optimizedQuery})});if(!response.ok){throw new Error('Error querying recent applications');}const data=await response.json();// If there are applications, filter them first and then show notification\nif(data.data&&data.data.length>0){console.log(`Received ${data.data.length} applications from the last 30 seconds`);// Filter out any applications that have already been notified\nconst newApps=data.data.filter(app=>{const isAlreadyNotified=notifiedApplications.has(app.id);if(isAlreadyNotified){console.log(`Skipping already notified application: ${app.id}`);return false;}// Convertir el timestamp de la aplicación a Date para comparar\nconst appCreatedAt=new Date(app.created_at);// Si la aplicación es de hace más de 60 segundos, no notificar\nconst isTooOld=new Date().getTime()-appCreatedAt.getTime()>60000;if(isTooOld){console.log(`Skipping too old application: ${app.id} created at ${appCreatedAt.toISOString()}`);// Marcar como notificada para evitar mostrarla en futuras verificaciones\nconst appMetadata={notifiedAt:new Date().toISOString(),notificationType:'application',applicationType:app.application_type,amount:app.amount,clientName:app.client_name,companyName:app.company_name,status:app.status};markApplicationAsNotified(app.id,app.created_at,appMetadata);return false;}return true;});console.log(`Found ${newApps.length} new applications after filtering`);if(newApps.length===0){console.log('No truly new applications found (already notified or too old)');checkingRef.current=false;return;}// Take only the first new application to show\nconst newApp=newApps[0];const appId=newApp.id;// Verificar si ya está en proceso de notificación (para evitar doble notificación)\nif(currentPopup&&currentPopup.relatedItemId===appId){console.log(`Already showing notification for application ${appId} - skipping`);checkingRef.current=false;return;}console.log(`New application detected: ${appId} (created ${new Date(newApp.created_at).toISOString()})`);// IMPORTANT: Mark as notified IMMEDIATELY to prevent duplicates\n// even if processing fails later\nconst appMetadata={notifiedAt:new Date().toISOString(),notificationType:'application',applicationType:newApp.application_type,amount:newApp.amount,clientName:newApp.client_name,companyName:newApp.company_name,status:newApp.status};markApplicationAsNotified(appId,newApp.created_at,appMetadata);// Format data for notification\nconst createdAt=new Date(newApp.created_at);const formattedDate=new Intl.DateTimeFormat('es-MX',{day:'2-digit',month:'2-digit',year:'numeric'}).format(createdAt);const formattedTime=new Intl.DateTimeFormat('es-MX',{hour:'2-digit',minute:'2-digit',hour12:true}).format(createdAt);// Format amount with thousands separator and 2 decimals\nconst formattedAmount=new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:2}).format(Number(newApp.amount||0));// Format interest rate with percentage\nconst formattedRate=newApp.interest_rate!==null&&newApp.interest_rate!==undefined?`${newApp.interest_rate}%`:\"N/A\";// Format monthly payment\nconst formattedMonthly=newApp.monthly_payment!==null&&newApp.monthly_payment!==undefined?new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:2}).format(Number(newApp.monthly_payment)):\"N/A\";// Transform application type to a more readable format\nlet appType='No especificado';if(newApp.application_type){// Remove any trailing slash if it exists\nconst cleanType=newApp.application_type.replace(/\\/$/,'');if(cleanType==='selected_plans'){appType='Planes seleccionados';}else if(cleanType==='product_simulations'){appType='Simulación de producto';}else if(cleanType==='cash_requests'){appType='Solicitud de efectivo';}else if(cleanType==='car_backed_loan_applications'){appType='Préstamo con garantía de auto';}else if(cleanType==='auto_loan_applications'){appType='Préstamo para auto';}else{appType=cleanType.split('_').map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join(' ');}}// Adaptar la información según el tipo de aplicación\nconst getApplicationSpecificHtml=(appType,app)=>{// Base de los campos comunes para todos los tipos\nconst commonFields=`\n            <div class=\"font-semibold text-gray-700\">Cliente:</div>\n            <div class=\"text-gray-900\">${app.client_name||'Sin nombre'}</div>\n            \n            <div class=\"font-semibold text-gray-700\">Empresa:</div>\n            <div class=\"text-gray-900\">${app.company_name||'No especificada'}</div>\n            \n            <div class=\"font-semibold text-gray-700\">Tipo:</div>\n            <div class=\"text-gray-900\">${appType}</div>\n          `;// Campos específicos según el tipo de aplicación\nlet specificFields='';// Planes seleccionados - enfatizar plazo, tasa, pago mensual\nif(app.application_type==='selected_plans'){specificFields=`\n              <div class=\"font-semibold text-gray-700\">Monto:</div>\n              <div class=\"text-gray-900\">${formattedAmount}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Plazo:</div>\n              <div class=\"text-gray-900\">${app.term||'N/A'} ${app.term===1?'mes':'meses'}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Tasa:</div>\n              <div class=\"text-gray-900\">${formattedRate}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n              <div class=\"text-gray-900\">${formattedMonthly}</div>\n            `;}// Simulación de producto - enfatizar tipo de producto y monto total\nelse if(app.application_type==='product_simulations'){specificFields=`\n              <div class=\"font-semibold text-gray-700\">Monto:</div>\n              <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Plazo:</div>\n              <div class=\"text-gray-900\">${app.term&&app.term>0?app.term+(app.term===1?' mes':' meses'):'N/A'}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Tasa:</div>\n              <div class=\"text-gray-900\">${formattedRate}</div>\n            `;}// Solicitudes de efectivo - enfatizar monto solicitado\nelse if(app.application_type==='cash_requests'){specificFields=`\n              <div class=\"font-semibold text-gray-700\">Monto solicitado:</div>\n              <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Plazo:</div>\n              <div class=\"text-gray-900\">${app.term&&app.term>0?app.term+(app.term===1?' mes':' meses'):'N/A'}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Tasa:</div>\n              <div class=\"text-gray-900\">${formattedRate}</div>\n            `;}// Préstamos relacionados con autos\nelse if(app.application_type==='car_backed_loan_applications'||app.application_type==='auto_loan_applications'){specificFields=`\n              <div class=\"font-semibold text-gray-700\">Monto del préstamo:</div>\n              <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Plazo:</div>\n              <div class=\"text-gray-900\">${app.term&&app.term>0?app.term+(app.term===1?' mes':' meses'):'N/A'}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Tasa:</div>\n              <div class=\"text-gray-900\">${formattedRate}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n              <div class=\"text-gray-900\">${formattedMonthly}</div>\n            `;}// Para cualquier otro tipo\nelse{specificFields=`\n              <div class=\"font-semibold text-gray-700\">Monto:</div>\n              <div class=\"text-gray-900\">${formattedAmount}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Plazo:</div>\n              <div class=\"text-gray-900\">${app.term&&app.term>0?app.term+(app.term===1?' mes':' meses'):'N/A'}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Tasa:</div>\n              <div class=\"text-gray-900\">${formattedRate}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n              <div class=\"text-gray-900\">${formattedMonthly}</div>\n            `;}// Contacto y fecha - comunes para todos\nconst contactFields=`\n            <div class=\"font-semibold text-gray-700\">Email:</div>\n            <div class=\"text-gray-900\">${app.client_email||'No especificado'}</div>\n            \n            <div class=\"font-semibold text-gray-700\">Teléfono:</div>\n            <div class=\"text-gray-900\">${app.client_phone||'No especificado'}</div>\n            \n            <div class=\"font-semibold text-gray-700\">Fecha:</div>\n            <div class=\"text-gray-900\">${formattedDate} ${formattedTime}</div>\n          `;return`\n            <div class=\"grid grid-cols-2 gap-2 text-sm mt-2\">\n              ${commonFields}\n              ${specificFields}\n              ${contactFields}\n            </div>\n          `;};// Obtener el HTML específico según el tipo de aplicación\nconst detailedMessage=getApplicationSpecificHtml(appType,newApp);const notificationTitle='💼 Nueva solicitud recibida';// Create the notification for the panel\nconst newNotification={title:notificationTitle,message:`Cliente: ${newApp.client_name||'Sin nombre'} - ${newApp.company_name||'Empresa no especificada'}`,type:NotificationType.NEW_APPLICATION,relatedItemType:'application',relatedItemId:appId};// Add the notification to the panel\naddNotification(newNotification);// Show popup with complete details\nshowPopup({title:notificationTitle,message:detailedMessage,type:NotificationType.NEW_APPLICATION,playSound:soundEnabled,soundType:'notification',duration:10000,// 10 seconds\ncustomSound:'/sounds/clean-notification.mp3',centerScreen:true,relatedItemId:appId});// Update last notification time to avoid duplicates\nlastNotificationTimeRef.current=new Date();}else{console.log('No new applications found in the last 30 seconds');}}catch(error){console.error('Error checking for new notifications:',error);}finally{// Always mark as not running regardless of the result\ncheckingRef.current=false;}};// Añadir una nueva notificación\nconst addNotification=notification=>{const newNotification={...notification,// Using a proper UUID for the notification ID\nid:generateUUID(),createdAt:new Date(),read:false,timestamp:new Date()};setNotifications(prev=>{const updated=[newNotification,...prev];// Guardar en localStorage (en producción esto iría al servidor)\nlocalStorage.setItem('notifications',JSON.stringify(updated));return updated;});};// Marcar una notificación como leída\nconst markAsRead=id=>{setNotifications(prev=>{const updated=prev.map(notification=>notification.id===id?{...notification,read:true,isRead:true}:notification);// Guardar en localStorage\nlocalStorage.setItem('notifications',JSON.stringify(updated));return updated;});};// Marcar todas las notificaciones como leídas\nconst markAllAsRead=()=>{setNotifications(prev=>{const updated=prev.map(notification=>({...notification,read:true,isRead:true}));// Guardar en localStorage\nlocalStorage.setItem('notifications',JSON.stringify(updated));return updated;});};// Limpiar todas las notificaciones\nconst clearNotifications=()=>{setNotifications([]);// Limpiar del localStorage\nlocalStorage.setItem('notifications',JSON.stringify([]));};// Mostrar una notificación emergente\nconst showPopup=config=>{// Verificar si ya hay un popup con el mismo título y mensaje o mismo ID relacionado (posible duplicado)\nif(currentPopup&&(currentPopup.title===config.title&&currentPopup.message===config.message||config.relatedItemId&&currentPopup.relatedItemId===config.relatedItemId)){console.log(`Ignoring duplicate popup: ${config.relatedItemId||'unknown ID'}`);return;}// Clear any existing popups to prevent stacking\nclearPopups();// Log what we're showing\nconsole.log(`Showing popup: ${config.title} ${config.relatedItemId?`(ID: ${config.relatedItemId})`:''}`);// Short timeout to ensure DOM updates before showing the new popup\nsetTimeout(()=>{setCurrentPopup(config);// Automatically close popup after the specified duration\nsetTimeout(()=>{setCurrentPopup(null);},config.duration||5000);},50);};// Clear any pending popups\nconst clearPopups=()=>{if(currentPopup){console.log('Clearing existing popup');setCurrentPopup(null);}};// Activar/desactivar sonidos de notificación\nconst toggleSound=()=>{const newValue=!soundEnabled;setSoundEnabled(newValue);// Guardar preferencia en localStorage\nlocalStorage.setItem('notification_sound_enabled',newValue.toString());};const value={notifications,unreadCount,addNotification,markAsRead,markAllAsRead,clearNotifications,showPopup,soundEnabled,toggleSound,setSoundEnabled};return/*#__PURE__*/_jsxs(NotificationContext.Provider,{value:value,children:[children,currentPopup&&/*#__PURE__*/_jsx(NotificationPopup,{title:currentPopup.title,message:currentPopup.message,type:currentPopup.type,duration:currentPopup.duration,playSound:currentPopup.playSound,soundType:currentPopup.soundType,customSound:currentPopup.customSound,onClose:()=>setCurrentPopup(null),centerScreen:currentPopup.centerScreen})]});};","map":{"version":3,"names":["React","createContext","useContext","useState","useEffect","useRef","useAuth","NotificationPopup","jsx","_jsx","jsxs","_jsxs","generateUUID","replace","c","r","Math","random","v","toString","getTestApplicationId","sampleIds","floor","length","NotificationType","NotificationContext","undefined","useNotifications","context","Error","NotificationProvider","_ref","children","user","notifications","setNotifications","unreadCount","setUnreadCount","soundEnabled","setSoundEnabled","currentPopup","setCurrentPopup","pollingIntervalRef","notifiedApplications","setNotifiedApplications","Map","checkingRef","lastNotificationTimeRef","Date","lastCheckTimeRef","loadNotifications","storedNotifications","localStorage","getItem","parsedData","JSON","parse","Array","isArray","notifiedMap","now","forEach","id","set","saveNotifiedApplications","console","log","size","Object","entries","_ref2","timestamp","cleanupOldNotifications","error","current","initialCheckTimeout","setTimeout","initializeWithLastApplicationTimestamp","setInterval","timeSinceLastCheck","getTime","timeSinceLastNotification","checkForNewNotifications","toFixed","clearInterval","clearTimeout","response","fetch","method","headers","body","stringify","query","ok","data","json","lastApp","lastAppId","lastAppCreatedAt","created_at","toISOString","has","appMetadata","notifiedAt","notificationType","applicationType","application_type","amount","clientName","client_name","companyName","company_name","status","markApplicationAsNotified","count","filter","notification","read","parsed","map","n","createdAt","notifiedObject","setItem","twentyFourHoursAgo","totalCount","cleanedCount","updatedNotifications","applicationId","createdTimestamp","metadata","notificationTime","creationTime","warn","updatedMap","metadataKey","getOptimizedQuery","typeCheckResponse","getDefaultQuery","typeData","latestType","additionalFields","clearPopups","hasChanges","_ref3","notifiedIdsArray","from","keys","join","substring","optimizedQuery","newApps","app","isAlreadyNotified","appCreatedAt","isTooOld","newApp","appId","relatedItemId","formattedDate","Intl","DateTimeFormat","day","month","year","format","formattedTime","hour","minute","hour12","formattedAmount","NumberFormat","style","currency","minimumFractionDigits","Number","formattedRate","interest_rate","formattedMonthly","monthly_payment","appType","cleanType","split","word","charAt","toUpperCase","slice","getApplicationSpecificHtml","commonFields","specificFields","term","contactFields","client_email","client_phone","detailedMessage","notificationTitle","newNotification","title","message","type","NEW_APPLICATION","relatedItemType","addNotification","showPopup","playSound","soundType","duration","customSound","centerScreen","prev","updated","markAsRead","isRead","markAllAsRead","clearNotifications","config","toggleSound","newValue","value","Provider","onClose"],"sources":["/Users/diegogg98/NEW CRM MAR18/src/contexts/NotificationContext.tsx"],"sourcesContent":["import React, { createContext, useContext, useState, useEffect, useRef } from 'react';\nimport { useAuth } from './AuthContext';\nimport NotificationPopup from '../components/ui/NotificationPopup';\n\n// Generate a proper UUID for notification IDs\nfunction generateUUID() {\n  // Use a more standard implementation for UUID v4\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\n// For test notifications, use a valid UUID format - don't use app-timestamp\nfunction getTestApplicationId() {\n  // Use a small set of real UUIDs as sample application IDs\n  const sampleIds = [\n    '110cc76a-1762-4df4-840e-a503fea9d7aa',\n    '220cc76a-1762-4df4-840e-a503fea9d7bb',\n    '330cc76a-1762-4df4-840e-a503fea9d7cc',\n    '440cc76a-1762-4df4-840e-a503fea9d7dd',\n    '550cc76a-1762-4df4-840e-a503fea9d7ee'\n  ];\n  \n  // Pick a random ID from the sample list\n  return sampleIds[Math.floor(Math.random() * sampleIds.length)];\n}\n\n// Enum for notification types\nexport enum NotificationType {\n  INFO = 'info',\n  SUCCESS = 'success',\n  WARNING = 'warning',\n  ERROR = 'error',\n  NEW_APPLICATION = 'new_application',\n  APPROVAL_REQUIRED = 'approval_required',\n  NEW_MESSAGE = 'new_message',\n  APPLICATION_STATUS_UPDATED = 'application_status_updated',\n  APPLICATION_COMMENT = 'application_comment',\n}\n\n// Interfaces\ninterface Notification {\n  id: string;\n  title: string;\n  message: string;\n  createdAt: Date;\n  read: boolean;\n  type: NotificationType | 'info' | 'success' | 'warning' | 'error';\n  relatedItemId?: string;\n  relatedItemType?: string;\n  data?: any;\n  timestamp?: Date;\n  isRead?: boolean;\n}\n\ninterface NotificationPopupConfig {\n  title: string;\n  message: string;\n  type?: NotificationType | 'info' | 'success' | 'warning' | 'error';\n  duration?: number;\n  playSound?: boolean;\n  soundType?: 'notification' | 'alert' | 'approval';\n  customSound?: string;\n  centerScreen?: boolean;\n  relatedItemId?: string; // ID del elemento relacionado (como una aplicación)\n}\n\ninterface NotificationContextType {\n  notifications: Notification[];\n  unreadCount: number;\n  addNotification: (notification: Omit<Notification, 'id' | 'createdAt' | 'read'>) => void;\n  markAsRead: (id: string) => void;\n  markAllAsRead: () => void;\n  clearNotifications: () => void;\n  showPopup: (config: NotificationPopupConfig) => void;\n  soundEnabled: boolean;\n  toggleSound: () => void;\n  setSoundEnabled: (enabled: boolean) => void;\n}\n\nexport const NotificationContext = createContext<NotificationContextType | undefined>(undefined);\n\nexport const useNotifications = () => {\n  const context = useContext(NotificationContext);\n  if (context === undefined) {\n    throw new Error('useNotifications must be used within a NotificationProvider');\n  }\n  return context;\n};\n\nexport const NotificationProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\n  const { user } = useAuth();\n  const [notifications, setNotifications] = useState<Notification[]>([]);\n  const [unreadCount, setUnreadCount] = useState<number>(0);\n  const [soundEnabled, setSoundEnabled] = useState<boolean>(true);\n  \n  // Estado para la notificación emergente actual\n  const [currentPopup, setCurrentPopup] = useState<NotificationPopupConfig | null>(null);\n  \n  // Referencia al ID del polling interval\n  const pollingIntervalRef = useRef<NodeJS.Timeout | null>(null);\n\n  // State to keep track of already notified application IDs with timestamps\n  // This helps prevent showing the same notification multiple times\n  const [notifiedApplications, setNotifiedApplications] = useState<Map<string, number>>(new Map());\n\n  // Referencia para evitar múltiples ejecuciones simultáneas\n  const checkingRef = useRef<boolean>(false);\n  \n  // Reference to the latest known notification time\n  const lastNotificationTimeRef = useRef<Date>(new Date());\n  \n  // Avoid duplicate notifications by ensuring we have a minimum interval between checks\n  const lastCheckTimeRef = useRef<Date>(new Date());\n\n  // Efecto para manejar la carga inicial de notificaciones y configurar el polling\n  useEffect(() => {\n    if (user) {\n      // Cargar notificaciones al inicio\n      loadNotifications();\n\n      // Cargar aplicaciones ya notificadas desde localStorage\n      try {\n        const storedNotifications = localStorage.getItem('notified_application_ids');\n        if (storedNotifications) {\n          const parsedData = JSON.parse(storedNotifications);\n          \n          // Handle both old format (array) and new format (object with timestamps)\n          if (Array.isArray(parsedData)) {\n            // Old format - convert to new Map with current timestamp\n            const notifiedMap = new Map();\n            const now = Date.now();\n            parsedData.forEach((id: string) => {\n              notifiedMap.set(id, now);\n            });\n            setNotifiedApplications(notifiedMap);\n            // Re-save with the new format\n            saveNotifiedApplications(notifiedMap);\n            console.log(`Converted ${notifiedMap.size} notified application IDs from old format to new format`);\n          } else if (typeof parsedData === 'object') {\n            // New format - convert object to Map\n            const notifiedMap = new Map();\n            Object.entries(parsedData).forEach(([id, timestamp]) => {\n              notifiedMap.set(id, timestamp as number);\n            });\n            setNotifiedApplications(notifiedMap);\n            console.log(`Loaded ${notifiedMap.size} notified application IDs from localStorage`);\n          }\n        } else {\n          console.log('No previously notified applications found in localStorage');\n        }\n        \n        // Limpiar notificaciones antiguas (más de 48 horas)\n        cleanupOldNotifications();\n      } catch (error) {\n        console.error('Error loading notified applications:', error);\n        // Reset if there's an error\n        setNotifiedApplications(new Map());\n      }\n      \n      // Set the initial last check time to now\n      lastCheckTimeRef.current = new Date();\n      // Set the initial last notification time to 10 seconds ago to avoid immediate checks\n      lastNotificationTimeRef.current = new Date(Date.now() - 10000);\n      \n      // Wait 5 seconds before first check to ensure UI is fully loaded\n      const initialCheckTimeout = setTimeout(() => {\n        // Primero obtenemos la fecha de la última aplicación para inicializar el sistema\n        initializeWithLastApplicationTimestamp();\n        \n        // Configurar polling para verificar nuevas notificaciones cada 30 seconds\n        // Utilizamos un intervalo más corto para estar más atentos a nuevas solicitudes\n        pollingIntervalRef.current = setInterval(() => {\n          const now = new Date();\n          const timeSinceLastCheck = now.getTime() - lastCheckTimeRef.current.getTime();\n          const timeSinceLastNotification = now.getTime() - lastNotificationTimeRef.current.getTime();\n          \n          // Only check if:\n          // 1. It's been at least 15 seconds since last check AND\n          // 2. It's been at least 5 seconds since showing a notification\n          if (timeSinceLastCheck > 15000 && timeSinceLastNotification > 5000) {\n            checkForNewNotifications();\n          } else {\n            console.log(`Skipping notification check (last check: ${(timeSinceLastCheck/1000).toFixed(1)}s ago, last notification: ${(timeSinceLastNotification/1000).toFixed(1)}s ago)`);\n          }\n        }, 20000);\n      }, 5000);\n      \n      // Limpiar el intervalo cuando el componente se desmonte\n      return () => {\n        if (pollingIntervalRef.current) {\n          clearInterval(pollingIntervalRef.current);\n        }\n        clearTimeout(initialCheckTimeout);\n      };\n    }\n  }, [user]);\n\n  // Inicializar con el timestamp de la última aplicación\n  const initializeWithLastApplicationTimestamp = async () => {\n    try {\n      // Obtener la última aplicación para usarla como referencia inicial\n      const response = await fetch('http://localhost:3100/query', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          query: `\n            SELECT id, created_at, application_type, client_name, company_name, status, amount\n            FROM applications \n            ORDER BY created_at DESC\n            LIMIT 1\n          `\n        })\n      });\n      \n      if (!response.ok) {\n        throw new Error('Error querying most recent application');\n      }\n      \n      const data = await response.json();\n      \n      if (data.data && data.data.length > 0) {\n        const lastApp = data.data[0];\n        const lastAppId = lastApp.id;\n        const lastAppCreatedAt = new Date(lastApp.created_at);\n        \n        console.log(`System initialized with reference to last application: ${lastAppId} created at ${lastAppCreatedAt.toISOString()}`);\n        \n        // Marcar la aplicación más reciente como ya notificada para evitar duplicados al inicio\n        if (!notifiedApplications.has(lastAppId)) {\n          const appMetadata = {\n            notifiedAt: new Date().toISOString(),\n            notificationType: 'initialization',\n            applicationType: lastApp.application_type,\n            amount: lastApp.amount,\n            clientName: lastApp.client_name,\n            companyName: lastApp.company_name,\n            status: lastApp.status\n          };\n          markApplicationAsNotified(lastAppId, lastApp.created_at, appMetadata);\n        }\n      }\n      \n      // Realizar la primera verificación de notificaciones\n      checkForNewNotifications();\n    } catch (error) {\n      console.error('Error initializing with last application timestamp:', error);\n      // Si falla, aún intentamos la primera verificación\n      checkForNewNotifications();\n    }\n  };\n\n  // Cálculo de notificaciones no leídas\n  useEffect(() => {\n    const count = notifications.filter(notification => !notification.read).length;\n    setUnreadCount(count);\n  }, [notifications]);\n\n  // Cargar notificaciones del almacenamiento local o del servidor\n  const loadNotifications = async () => {\n    try {\n      // En un escenario real, aquí se cargarían las notificaciones del servidor\n      // Por ahora, usaremos el localStorage como ejemplo\n      const storedNotifications = localStorage.getItem('notifications');\n      if (storedNotifications) {\n        const parsed = JSON.parse(storedNotifications);\n        setNotifications(parsed.map((n: any) => ({\n          ...n,\n          createdAt: new Date(n.createdAt)\n        })));\n      }\n    } catch (error) {\n      console.error('Error loading notifications:', error);\n    }\n  };\n\n  // Save notified applications with timestamps to localStorage\n  const saveNotifiedApplications = (notifiedMap: Map<string, number>) => {\n    try {\n      // Convert Map to object for storage\n      const notifiedObject: Record<string, number> = {};\n      notifiedMap.forEach((timestamp, id) => {\n        notifiedObject[id] = timestamp;\n      });\n      \n      localStorage.setItem('notified_application_ids', JSON.stringify(notifiedObject));\n      console.log(`Saved ${notifiedMap.size} notified application IDs to localStorage`);\n    } catch (error) {\n      console.error('Error saving notified applications:', error);\n    }\n  };\n\n  // Función para limpiar notificaciones antiguas\n  const cleanupOldNotifications = () => {\n    try {\n      const now = Date.now();\n      const twentyFourHoursAgo = now - (24 * 60 * 60 * 1000); // 24 horas en milisegundos\n      \n      let totalCount = 0;\n      let cleanedCount = 0;\n      \n      // Crear un nuevo mapa para guardar solo las notificaciones más recientes\n      const updatedNotifications = new Map();\n      \n      notifiedApplications.forEach((timestamp, id) => {\n        totalCount++;\n        if (timestamp > twentyFourHoursAgo) {\n          // Mantener solo las notificaciones de las últimas 24 horas\n          updatedNotifications.set(id, timestamp);\n        } else {\n          cleanedCount++;\n        }\n      });\n      \n      if (cleanedCount > 0) {\n        console.log(`Cleaned up ${cleanedCount} old notification records (${totalCount - cleanedCount} retained)`);\n        setNotifiedApplications(updatedNotifications);\n        saveNotifiedApplications(updatedNotifications);\n      } else if (totalCount > 0) {\n        console.log(`No old notifications to clean up (${totalCount} notifications are all within 24 hours)`);\n      }\n    } catch (error) {\n      console.error('Error cleaning up old notifications:', error);\n    }\n  };\n\n  // Marcar una aplicación como notificada\n  const markApplicationAsNotified = (applicationId: string, createdTimestamp?: string, metadata?: any) => {\n    // Check if already marked as notified\n    if (notifiedApplications.has(applicationId)) {\n      console.log(`Application ${applicationId} already marked as notified (duplicate protection)`);\n      return; // Already notified, don't do anything\n    }\n    \n    try {\n      let notificationTime: number;\n      \n      // If createdTimestamp is provided, use it to set notification time just after creation\n      if (createdTimestamp) {\n        try {\n          // Try to parse the creation timestamp\n          const creationTime = new Date(createdTimestamp);\n          // Set notification time 1 second after creation to ensure proper ordering\n          notificationTime = creationTime.getTime() + 1000;\n          console.log(`Using application creation time for notification: ${creationTime.toISOString()}`);\n        } catch (error) {\n          // If parsing fails, use current time as fallback\n          console.warn(`Error parsing creation timestamp \"${createdTimestamp}\":`, error);\n          notificationTime = Date.now();\n        }\n      } else {\n        // If no timestamp provided, use current time\n        notificationTime = Date.now();\n      }\n      \n      // Crear un objeto de metadatos para esta aplicación si no se proporcionó uno\n      const appMetadata = metadata || {\n        notifiedAt: new Date(notificationTime).toISOString(),\n        notificationType: 'application',\n      };\n      \n      // Save to the notified applications map\n      const updatedMap = new Map(notifiedApplications);\n      updatedMap.set(applicationId, notificationTime);\n      setNotifiedApplications(updatedMap);\n      \n      // Guardar también los metadatos si es necesario para futuras optimizaciones\n      try {\n        const metadataKey = `notification_metadata_${applicationId}`;\n        localStorage.setItem(metadataKey, JSON.stringify(appMetadata));\n      } catch (error) {\n        console.warn('Error saving notification metadata:', error);\n      }\n      \n      // Save to localStorage\n      saveNotifiedApplications(updatedMap);\n      \n      // Update last notification time\n      lastNotificationTimeRef.current = new Date();\n      \n      console.log(`Marked application ${applicationId} as notified at ${new Date(notificationTime).toISOString()}`);\n    } catch (error) {\n      console.error('Error marking application as notified:', error);\n    }\n  };\n\n  // Función para obtener la consulta SQL optimizada según el tipo de aplicación más reciente\n  const getOptimizedQuery = async (): Promise<string> => {\n    try {\n      // Primero, verificar el tipo de la aplicación más reciente para optimizar la consulta\n      const typeCheckResponse = await fetch('http://localhost:3100/query', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          query: `\n            SELECT application_type\n            FROM applications \n            ORDER BY created_at DESC\n            LIMIT 1\n          `\n        })\n      });\n      \n      if (!typeCheckResponse.ok) {\n        console.warn('Error checking latest application type, using default query');\n        return getDefaultQuery();\n      }\n      \n      const typeData = await typeCheckResponse.json();\n      \n      if (!typeData.data || typeData.data.length === 0) {\n        console.log('No applications found, using default query');\n        return getDefaultQuery();\n      }\n      \n      const latestType = typeData.data[0].application_type;\n      console.log(`Latest application type: ${latestType}`);\n      \n      // Personalizar los campos según el tipo de aplicación\n      let additionalFields = '';\n      \n      switch(latestType) {\n        case 'selected_plans':\n          // Para planes seleccionados, necesitamos plazo, tasa y pago mensual\n          additionalFields = '';\n          break;\n        case 'product_simulations':\n          // Para simulaciones, podríamos necesitar campos específicos del producto\n          additionalFields = '';\n          break;\n        case 'cash_requests':\n          // Para solicitudes de efectivo\n          additionalFields = '';\n          break;\n        case 'car_backed_loan_applications':\n        case 'auto_loan_applications':\n          // Para préstamos de auto, podríamos necesitar datos del vehículo\n          additionalFields = '';\n          break;\n        default:\n          additionalFields = '';\n      }\n      \n      // Construir consulta con base en el tipo\n      return `\n        SELECT id, client_name, application_type, company_name, created_at, status, \n               amount, term, interest_rate, monthly_payment, client_email, client_phone ${additionalFields}\n        FROM applications \n        WHERE created_at > NOW() - INTERVAL '30 seconds'\n        ORDER BY created_at DESC\n        LIMIT 5\n      `;\n      \n    } catch (error) {\n      console.error('Error building optimized query:', error);\n      return getDefaultQuery();\n    }\n  };\n  \n  // Consulta predeterminada con campos básicos\n  const getDefaultQuery = (): string => {\n    return `\n      SELECT id, client_name, application_type, company_name, created_at, status, \n             amount, term, interest_rate, monthly_payment, client_email, client_phone\n      FROM applications \n      WHERE created_at > NOW() - INTERVAL '30 seconds'\n      ORDER BY created_at DESC\n      LIMIT 5\n    `;\n  };\n\n  const checkForNewNotifications = async () => {\n    // Record the check time immediately to prevent race conditions\n    lastCheckTimeRef.current = new Date();\n    \n    // Avoid multiple executions at the same time\n    if (checkingRef.current) {\n      console.log('Already checking for notifications');\n      return;\n    }\n    \n    // Make sure we don't have any lingering popups\n    clearPopups();\n    \n    // Sincronizar con localStorage antes de verificar para evitar duplicados\n    try {\n      const storedNotifications = localStorage.getItem('notified_application_ids');\n      if (storedNotifications) {\n        const parsedData = JSON.parse(storedNotifications);\n        if (typeof parsedData === 'object' && !Array.isArray(parsedData)) {\n          // Fusionar con las notificaciones actuales\n          const updatedMap = new Map(notifiedApplications);\n          let hasChanges = false;\n          \n          Object.entries(parsedData).forEach(([id, timestamp]) => {\n            if (!updatedMap.has(id)) {\n              updatedMap.set(id, timestamp as number);\n              hasChanges = true;\n            }\n          });\n          \n          if (hasChanges) {\n            console.log('Synchronized notification IDs from localStorage before checking');\n            setNotifiedApplications(updatedMap);\n          }\n        }\n      }\n    } catch (error) {\n      console.error('Error synchronizing notifications from localStorage:', error);\n    }\n    \n    checkingRef.current = true;\n    console.log('Checking for new notifications...');\n    \n    try {\n      // Convert notified IDs Map to array for logging\n      const notifiedIdsArray = Array.from(notifiedApplications.keys());\n      console.log(`${notifiedIdsArray.length} already notified application IDs: ${notifiedIdsArray.join(', ').substring(0, 200)}${notifiedIdsArray.length > 5 ? '...' : ''}`);\n      \n      // Obtener consulta optimizada según tipo de aplicación\n      const optimizedQuery = await getOptimizedQuery();\n      console.log('Using optimized query for latest application type');\n      \n      const response = await fetch('http://localhost:3100/query', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ query: optimizedQuery })\n      });\n      \n      if (!response.ok) {\n        throw new Error('Error querying recent applications');\n      }\n      \n      const data = await response.json();\n      \n      // If there are applications, filter them first and then show notification\n      if (data.data && data.data.length > 0) {\n        console.log(`Received ${data.data.length} applications from the last 30 seconds`);\n        \n        // Filter out any applications that have already been notified\n        const newApps = data.data.filter((app: any) => {\n          const isAlreadyNotified = notifiedApplications.has(app.id);\n          if (isAlreadyNotified) {\n            console.log(`Skipping already notified application: ${app.id}`);\n            return false;\n          }\n          \n          // Convertir el timestamp de la aplicación a Date para comparar\n          const appCreatedAt = new Date(app.created_at);\n          \n          // Si la aplicación es de hace más de 60 segundos, no notificar\n          const isTooOld = (new Date().getTime() - appCreatedAt.getTime()) > 60000;\n          if (isTooOld) {\n            console.log(`Skipping too old application: ${app.id} created at ${appCreatedAt.toISOString()}`);\n            // Marcar como notificada para evitar mostrarla en futuras verificaciones\n            const appMetadata = {\n              notifiedAt: new Date().toISOString(),\n              notificationType: 'application',\n              applicationType: app.application_type,\n              amount: app.amount,\n              clientName: app.client_name,\n              companyName: app.company_name,\n              status: app.status\n            };\n            markApplicationAsNotified(app.id, app.created_at, appMetadata);\n            return false;\n          }\n          \n          return true;\n        });\n        \n        console.log(`Found ${newApps.length} new applications after filtering`);\n        \n        if (newApps.length === 0) {\n          console.log('No truly new applications found (already notified or too old)');\n          checkingRef.current = false;\n          return;\n        }\n        \n        // Take only the first new application to show\n        const newApp = newApps[0];\n        const appId = newApp.id;\n        \n        // Verificar si ya está en proceso de notificación (para evitar doble notificación)\n        if (currentPopup && currentPopup.relatedItemId === appId) {\n          console.log(`Already showing notification for application ${appId} - skipping`);\n          checkingRef.current = false;\n          return;\n        }\n        \n        console.log(`New application detected: ${appId} (created ${new Date(newApp.created_at).toISOString()})`);\n        \n        // IMPORTANT: Mark as notified IMMEDIATELY to prevent duplicates\n        // even if processing fails later\n        const appMetadata = {\n          notifiedAt: new Date().toISOString(),\n          notificationType: 'application',\n          applicationType: newApp.application_type,\n          amount: newApp.amount,\n          clientName: newApp.client_name,\n          companyName: newApp.company_name,\n          status: newApp.status\n        };\n        markApplicationAsNotified(appId, newApp.created_at, appMetadata);\n          \n        // Format data for notification\n        const createdAt = new Date(newApp.created_at);\n        const formattedDate = new Intl.DateTimeFormat('es-MX', {\n          day: '2-digit',\n          month: '2-digit',\n          year: 'numeric'\n        }).format(createdAt);\n        \n        const formattedTime = new Intl.DateTimeFormat('es-MX', {\n          hour: '2-digit',\n          minute: '2-digit',\n          hour12: true\n        }).format(createdAt);\n        \n        // Format amount with thousands separator and 2 decimals\n        const formattedAmount = new Intl.NumberFormat('es-MX', {\n          style: 'currency',\n          currency: 'MXN',\n          minimumFractionDigits: 2\n        }).format(Number(newApp.amount || 0));\n        \n        // Format interest rate with percentage\n        const formattedRate = newApp.interest_rate !== null && newApp.interest_rate !== undefined \n          ? `${newApp.interest_rate}%` \n          : \"N/A\";\n        \n        // Format monthly payment\n        const formattedMonthly = newApp.monthly_payment !== null && newApp.monthly_payment !== undefined\n          ? new Intl.NumberFormat('es-MX', {\n              style: 'currency',\n              currency: 'MXN',\n              minimumFractionDigits: 2\n            }).format(Number(newApp.monthly_payment))\n          : \"N/A\";\n        \n        // Transform application type to a more readable format\n        let appType = 'No especificado';\n        if (newApp.application_type) {\n          // Remove any trailing slash if it exists\n          const cleanType = newApp.application_type.replace(/\\/$/, '');\n          \n          if (cleanType === 'selected_plans') {\n            appType = 'Planes seleccionados';\n          } else if (cleanType === 'product_simulations') {\n            appType = 'Simulación de producto';\n          } else if (cleanType === 'cash_requests') {\n            appType = 'Solicitud de efectivo';\n          } else if (cleanType === 'car_backed_loan_applications') {\n            appType = 'Préstamo con garantía de auto';\n          } else if (cleanType === 'auto_loan_applications') {\n            appType = 'Préstamo para auto';\n          } else {\n            appType = cleanType\n              .split('_')\n              .map((word: string) => word.charAt(0).toUpperCase() + word.slice(1))\n              .join(' ');\n          }\n        }\n\n        // Adaptar la información según el tipo de aplicación\n        const getApplicationSpecificHtml = (appType: string, app: any) => {\n          // Base de los campos comunes para todos los tipos\n          const commonFields = `\n            <div class=\"font-semibold text-gray-700\">Cliente:</div>\n            <div class=\"text-gray-900\">${app.client_name || 'Sin nombre'}</div>\n            \n            <div class=\"font-semibold text-gray-700\">Empresa:</div>\n            <div class=\"text-gray-900\">${app.company_name || 'No especificada'}</div>\n            \n            <div class=\"font-semibold text-gray-700\">Tipo:</div>\n            <div class=\"text-gray-900\">${appType}</div>\n          `;\n\n          // Campos específicos según el tipo de aplicación\n          let specificFields = '';\n\n          // Planes seleccionados - enfatizar plazo, tasa, pago mensual\n          if (app.application_type === 'selected_plans') {\n            specificFields = `\n              <div class=\"font-semibold text-gray-700\">Monto:</div>\n              <div class=\"text-gray-900\">${formattedAmount}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Plazo:</div>\n              <div class=\"text-gray-900\">${app.term || 'N/A'} ${app.term === 1 ? 'mes' : 'meses'}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Tasa:</div>\n              <div class=\"text-gray-900\">${formattedRate}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n              <div class=\"text-gray-900\">${formattedMonthly}</div>\n            `;\n          } \n          // Simulación de producto - enfatizar tipo de producto y monto total\n          else if (app.application_type === 'product_simulations') {\n            specificFields = `\n              <div class=\"font-semibold text-gray-700\">Monto:</div>\n              <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Plazo:</div>\n              <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Tasa:</div>\n              <div class=\"text-gray-900\">${formattedRate}</div>\n            `;\n          } \n          // Solicitudes de efectivo - enfatizar monto solicitado\n          else if (app.application_type === 'cash_requests') {\n            specificFields = `\n              <div class=\"font-semibold text-gray-700\">Monto solicitado:</div>\n              <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Plazo:</div>\n              <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Tasa:</div>\n              <div class=\"text-gray-900\">${formattedRate}</div>\n            `;\n          }\n          // Préstamos relacionados con autos\n          else if (app.application_type === 'car_backed_loan_applications' || app.application_type === 'auto_loan_applications') {\n            specificFields = `\n              <div class=\"font-semibold text-gray-700\">Monto del préstamo:</div>\n              <div class=\"text-gray-900 font-bold\">${formattedAmount}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Plazo:</div>\n              <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Tasa:</div>\n              <div class=\"text-gray-900\">${formattedRate}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n              <div class=\"text-gray-900\">${formattedMonthly}</div>\n            `;\n          }\n          // Para cualquier otro tipo\n          else {\n            specificFields = `\n              <div class=\"font-semibold text-gray-700\">Monto:</div>\n              <div class=\"text-gray-900\">${formattedAmount}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Plazo:</div>\n              <div class=\"text-gray-900\">${app.term && app.term > 0 ? app.term + (app.term === 1 ? ' mes' : ' meses') : 'N/A'}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Tasa:</div>\n              <div class=\"text-gray-900\">${formattedRate}</div>\n              \n              <div class=\"font-semibold text-gray-700\">Pago mensual:</div>\n              <div class=\"text-gray-900\">${formattedMonthly}</div>\n            `;\n          }\n\n          // Contacto y fecha - comunes para todos\n          const contactFields = `\n            <div class=\"font-semibold text-gray-700\">Email:</div>\n            <div class=\"text-gray-900\">${app.client_email || 'No especificado'}</div>\n            \n            <div class=\"font-semibold text-gray-700\">Teléfono:</div>\n            <div class=\"text-gray-900\">${app.client_phone || 'No especificado'}</div>\n            \n            <div class=\"font-semibold text-gray-700\">Fecha:</div>\n            <div class=\"text-gray-900\">${formattedDate} ${formattedTime}</div>\n          `;\n\n          return `\n            <div class=\"grid grid-cols-2 gap-2 text-sm mt-2\">\n              ${commonFields}\n              ${specificFields}\n              ${contactFields}\n            </div>\n          `;\n        };\n        \n        // Obtener el HTML específico según el tipo de aplicación\n        const detailedMessage = getApplicationSpecificHtml(appType, newApp);\n        \n        const notificationTitle = '💼 Nueva solicitud recibida';\n        \n        // Create the notification for the panel\n        const newNotification = {\n          title: notificationTitle,\n          message: `Cliente: ${newApp.client_name || 'Sin nombre'} - ${newApp.company_name || 'Empresa no especificada'}`,\n          type: NotificationType.NEW_APPLICATION,\n          relatedItemType: 'application',\n          relatedItemId: appId\n        };\n        \n        // Add the notification to the panel\n        addNotification(newNotification);\n        \n        // Show popup with complete details\n        showPopup({\n          title: notificationTitle,\n          message: detailedMessage,\n          type: NotificationType.NEW_APPLICATION,\n          playSound: soundEnabled,\n          soundType: 'notification',\n          duration: 10000, // 10 seconds\n          customSound: '/sounds/clean-notification.mp3',\n          centerScreen: true,\n          relatedItemId: appId\n        });\n        \n        // Update last notification time to avoid duplicates\n        lastNotificationTimeRef.current = new Date();\n      } else {\n        console.log('No new applications found in the last 30 seconds');\n      }\n\n    } catch (error) {\n      console.error('Error checking for new notifications:', error);\n    } finally {\n      // Always mark as not running regardless of the result\n      checkingRef.current = false;\n    }\n  };\n\n  // Añadir una nueva notificación\n  const addNotification = (notification: Omit<Notification, 'id' | 'createdAt' | 'read'>) => {\n    const newNotification: Notification = {\n      ...notification,\n      // Using a proper UUID for the notification ID\n      id: generateUUID(),\n      createdAt: new Date(),\n      read: false,\n      timestamp: new Date()\n    };\n    \n    setNotifications(prev => {\n      const updated = [newNotification, ...prev];\n      // Guardar en localStorage (en producción esto iría al servidor)\n      localStorage.setItem('notifications', JSON.stringify(updated));\n      return updated;\n    });\n  };\n\n  // Marcar una notificación como leída\n  const markAsRead = (id: string) => {\n    setNotifications(prev => {\n      const updated = prev.map(notification => \n        notification.id === id \n          ? { ...notification, read: true, isRead: true } \n          : notification\n      );\n      \n      // Guardar en localStorage\n      localStorage.setItem('notifications', JSON.stringify(updated));\n      return updated;\n    });\n  };\n\n  // Marcar todas las notificaciones como leídas\n  const markAllAsRead = () => {\n    setNotifications(prev => {\n      const updated = prev.map(notification => ({ ...notification, read: true, isRead: true }));\n      \n      // Guardar en localStorage\n      localStorage.setItem('notifications', JSON.stringify(updated));\n      return updated;\n    });\n  };\n\n  // Limpiar todas las notificaciones\n  const clearNotifications = () => {\n    setNotifications([]);\n    // Limpiar del localStorage\n    localStorage.setItem('notifications', JSON.stringify([]));\n  };\n\n  // Mostrar una notificación emergente\n  const showPopup = (config: NotificationPopupConfig) => {\n    // Verificar si ya hay un popup con el mismo título y mensaje o mismo ID relacionado (posible duplicado)\n    if (currentPopup && \n        ((currentPopup.title === config.title && currentPopup.message === config.message) ||\n         (config.relatedItemId && currentPopup.relatedItemId === config.relatedItemId))) {\n      console.log(`Ignoring duplicate popup: ${config.relatedItemId || 'unknown ID'}`);\n      return;\n    }\n\n    // Clear any existing popups to prevent stacking\n    clearPopups();\n    \n    // Log what we're showing\n    console.log(`Showing popup: ${config.title} ${config.relatedItemId ? `(ID: ${config.relatedItemId})` : ''}`);\n    \n    // Short timeout to ensure DOM updates before showing the new popup\n    setTimeout(() => {\n      setCurrentPopup(config);\n      \n      // Automatically close popup after the specified duration\n      setTimeout(() => {\n        setCurrentPopup(null);\n      }, config.duration || 5000);\n    }, 50);\n  };\n\n  // Clear any pending popups\n  const clearPopups = () => {\n    if (currentPopup) {\n      console.log('Clearing existing popup');\n      setCurrentPopup(null);\n    }\n  };\n\n  // Activar/desactivar sonidos de notificación\n  const toggleSound = () => {\n    const newValue = !soundEnabled;\n    setSoundEnabled(newValue);\n    // Guardar preferencia en localStorage\n    localStorage.setItem('notification_sound_enabled', newValue.toString());\n  };\n\n  const value = {\n    notifications,\n    unreadCount,\n    addNotification,\n    markAsRead,\n    markAllAsRead,\n    clearNotifications,\n    showPopup,\n    soundEnabled,\n    toggleSound,\n    setSoundEnabled\n  };\n\n  return (\n    <NotificationContext.Provider value={value}>\n      {children}\n      {currentPopup && (\n        <NotificationPopup\n          title={currentPopup.title}\n          message={currentPopup.message}\n          type={currentPopup.type as any}\n          duration={currentPopup.duration}\n          playSound={currentPopup.playSound}\n          soundType={currentPopup.soundType}\n          customSound={currentPopup.customSound}\n          onClose={() => setCurrentPopup(null)}\n          centerScreen={currentPopup.centerScreen}\n        />\n      )}\n    </NotificationContext.Provider>\n  );\n}; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}